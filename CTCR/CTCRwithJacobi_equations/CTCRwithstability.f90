      SUBROUTINE FUNC(NDIM,U,ICP,PAR,IJAC,F,DFDU,DFDP)
!     ---------- ----

      IMPLICIT NONE
      INTEGER, INTENT(IN) :: NDIM, ICP(*), IJAC
      DOUBLE PRECISION, INTENT(IN) :: U(NDIM), PAR(*)
      DOUBLE PRECISION, INTENT(OUT) :: F(NDIM)
      DOUBLE PRECISION, INTENT(INOUT) :: DFDU(NDIM,NDIM), DFDP(NDIM,*)
      DOUBLE PRECISION epsilon,entry11,entry12,entry13,entry14,k21,k22,k23,k11,k12,k13
      DOUBLE PRECISION entry21,entry22,entry23,entry24,ater1,ater2
      DOUBLE PRECISION aa1,aa2,aa3,ubar21,ubar22,ubar23,ubar11,ubar12,ubar13,A1,A2,C1,C2,addterm21
      DOUBLE PRECISION kb31,kb32,kb33,ub31,ub32,ub33,entry31,entry32,entry33,entry34,A3,C3,uhat13
      DOUBLE PRECISION m1(3),d21qn(4),d22qn(4),d23qn(4),pi,L1,L2,L3
      DOUBLE PRECISION m2(3),d11qn(4),d12qn(4),d13qn(4),dt23(3),m3(3),d31qn(4),d32qn(4),d33qn(4)
      DOUBLE PRECISION d11(3),d12(3),d13(3),v1(3),strain1(3),uhat11,uhat12,uhat21,uhat22
      DOUBLE PRECISION d21(3),d22(3),d23(3),v2(3),strain2(3),uhat23,strain3(3),v3(3)
      DOUBLE PRECISION ubar1,ubar2,ubar3,d31(3),d32(3),d33(3),ab1,ab2,uhat31,uhat32,uhat33
      DOUBLE PRECISION e201,e202,e203,e204,e205,e206,e207,e208,a201,b201,e211,e212,e213,e214,e215,e216,e217,e218,a211,b211
      DOUBLE PRECISION e221,e222,e223,e224,e225,e226,e227,e228,a221,b221,e231,e232,e233,e234,e235,e236,e237,e238,a231,b231
      DOUBLE PRECISION e241,e242,e243,e244,e245,e246,e247,e248,a241,b241,e251,e252,e253,e254,e255,e256,e257,e258,a251,b251
      DOUBLE PRECISION e261,e262,e263,e264,e265,e266,e267,e268,a261,b261,e271,e272,e273,e274,e275,e276,e277,e278,a271,b271
      DOUBLE PRECISION afq1,afq2,afq3,afq4,afm1,afm2,afm3,afm4,bq1,bq2,bq3,bq4,bm1,bm2,bm3,bm4,ba1
      DOUBLE PRECISION w201,w202,w203,w204,w205,w206,w207,w208,w211,w212,w213,w214,w215,w216,w217,w218,st1,st2
      DOUBLE PRECISION w221,w222,w223,w224,w225,w226,w227,w228,w231,w232,w233,w234,w235,w236,w237,w238
      DOUBLE PRECISION w241,w242,w243,w244,w245,w246,w247,w248,w251,w252,w253,w254,w255,w256,w257,w258
      DOUBLE PRECISION w261,w262,w263,w264,w265,w266,w267,w268,w271,w272,w273,w274,w275,w276,w277,w278
      DOUBLE PRECISION t201,t202,t203,t204,t205,t206,t207,t208,t211,t212,t213,t214,t215,t216,t217,t218
      DOUBLE PRECISION t221,t222,t223,t224,t225,t226,t227,t228,t231,t232,t233,t234,t235,t236,t237,t238
      DOUBLE PRECISION t241,t242,t243,t244,t245,t246,t247,t248,t251,t252,t253,t254,t255,t256,t257,t258
      DOUBLE PRECISION t261,t262,t263,t264,t265,t266,t267,t268,t271,t272,t273,t274,t275,t276,t277,t278
      DOUBLE PRECISION at201,at211,at221,at231,at241,at251,at261,at271,at281,at202,at212,at222,at232,at242,at252,at262,at272,at282
      DOUBLE PRECISION bt201,bt211,bt221,bt231,bt241,bt251,bt261,bt271,bt281,bt202,bt212,bt222,bt232,bt242,bt252,bt262,bt272,bt282
      DOUBLE PRECISION af2q1,af2q2,af2q3,af2q4,af2m1,af2m2,af2m3,af2m4,af3q1,af3q2,af3q3,af3q4,af3m1,af3m2,af3m3,af3m4
      DOUBLE PRECISION b2q1,b2q2,b2q3,b2q4,b2m1,b2m2,b2m3,b2m4,b3q1,b3q2,b3q3,b3q4,b3m1,b3m2,b3m3,b3m4,b2a2,b2a3,b3a2,b3a3
      DOUBLE PRECISION af2b2,af2b3,af3b2,af3b3
     INTEGER I,I1


      uhat11=PAR(5)
      uhat12=0.0d0
      uhat13=PAR(3)
      
      uhat21=PAR(6)
      uhat22=0.0d0
      uhat23=PAR(3)

      uhat31=PAR(11)
      uhat32=0.0d0
      uhat33=PAR(3)
  

     L2=PAR(1)
     L1=PAR(4)
     L3=PAR(10)
     
     A1=0.03487
     A2=0.09422
     A3=3.4
     C1=A1/1.3
     C2=A2/1.3
     C3=A3/1.3
     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! 

     	
    epsilon = 0.0d0
    aa1=1000.0d0
    aa2=1000.0d0
    aa3=1000.0d0
   
        
      m2(1) = (u(7)*u(8) + u(6)*u(9) - u(5)*u(10) - u(4)*u(11))/2.0d0
      m2(2) = (-u(6)*u(8) + u(7)*u(9) + u(4)*u(10) - u(5)*u(11))/2.0d0
      m2(3) = (u(5)*u(8) - u(4)*u(9) + u(7)*u(10) - u(6)*u(11))/2.0d0

!       The 4-vectors D_1[q] n, D_2[q] n, and D_3[q] n contain
!         the same 4 entries, but permuted and possibly negated.
!         Here are those entries

      entry21 =  2.0D0*(u(4)*u(12) + u(5)*u(13) + U(6)*u(14))
      entry22 =  2.0D0*(u(5)*u(12) - u(4)*u(13) + U(7)*u(14))
      entry23 =  2.0D0*(u(6)*u(12) - u(7)*u(13) - U(4)*u(14))
      entry24 =  2.0D0*(u(7)*u(12) + u(6)*u(13) - U(5)*u(14))

!       Components of D_1[q] n

      d21qn(1) =  entry21
      d21qn(2) =  -entry22
      d21qn(3) =  -entry23
      d21qn(4) =  entry24

!       Components of D_2[q] n

      d22qn(1) =  entry22
      d22qn(2) =  entry21
      d22qn(3) =  -entry24
      d22qn(4) =  -entry23

!       Components of D_3[q] n

      d23qn(1) =  entry23
      d23qn(2) =  entry24
      d23qn(3) =  entry21
      d23qn(4) =  entry22

!       Components of d1

      d21(1)= u(4)*u(4)-u(5)*u(5)-u(6)*u(6)+u(7)*u(7)
      d21(2)= 2.0d0*u(4)*u(5)+2.0d0*u(6)*u(7)
      d21(3)= 2.0d0*u(4)*u(6)-2.0d0*u(5)*u(7)

!       Components of d2

      d22(1)= 2.0d0*u(4)*u(5)-2.0d0*u(6)*u(7)
      d22(2)= -u(4)*u(4)+u(5)*u(5)-u(6)*u(6)+u(7)*u(7)
      d22(3)= 2.0d0*u(5)*u(6)+2.0d0*u(4)*u(7)

!       Components of d3

      d23(1)= 2.0d0*u(4)*u(6)+2.0d0*u(5)*u(7)
      d23(2)= 2.0d0*u(5)*u(6)-2.0d0*u(4)*u(7)
      d23(3)= -u(4)*u(4)-u(5)*u(5)+u(6)*u(6)+u(7)*u(7)

!       Components of v; note that v(3) has an extra term, due to
!         the fact that the unstressed state is assumed to have v=[0 0 1].

      v2(1)= epsilon/aa1*(d21(1)*u(12)+d21(2)*u(13)+d21(3)*u(14))
      v2(2)= epsilon/aa2*(d22(1)*u(12)+d22(2)*u(13)+d22(3)*u(14))
      v2(3)= epsilon/aa3*(d23(1)*u(12)+d23(2)*u(13)+d23(3)*u(14))+ 1.0d0
      
      ubar21=(A1*uhat11 + A2*(uhat21*COS(u(15))- uhat22*SIN(u(15)) ) )/(A1+A2)
      ubar22=(A1*uhat12 + A2*(uhat21*SIN(u(15))+ uhat22*COS(u(15)) ) )/(A1+A2)
      ubar23= -U(16)/C1 + m2(3)*C2/(C1*(C1+C2)) + uhat13   ! Corrected addterm to uhat13
      
      
     k21=A1+A2
     k22=A1+A2
     k23=C1+C2  

      strain2(1) = m2(1)/k21 + ubar21
      strain2(2) = m2(2)/k22 + ubar22
      strain2(3) = m2(3)/k23 + ubar23  !

!       Additional terms      

      F(1) = L2*( v2(1)*d21(1)+v2(2)*d22(1)+v2(3)*d23(1))
      F(2) = L2*(v2(1)*d21(2)+v2(2)*d22(2)+v2(3)*d23(2))
      F(3) = L2*(v2(1)*d21(3)+v2(2)*d22(3)+v2(3)*d23(3))
      F(4) = L2*(strain2(1)*u(7)/2.0d0 - strain2(2)*u(6)/2.0d0 + strain2(3)*u(5)/2.0d0)
      F(5) = L2*(strain2(1)*u(6)/2.0d0 + strain2(2)*u(7)/2.0d0 - strain2(3)*u(4)/2.0d0)
      F(6) = L2*(-strain2(1)*u(5)/2.0d0 + strain2(2)*u(4)/2.0d0 + strain2(3)*u(7)/2.0d0)
      F(7) = L2*(-strain2(1)*u(4)/2.0d0 - strain2(2)*u(5)/2.0d0 - strain2(3)*u(6)/2.0d0)
	F(8) =L2*(strain2(1)*u(11)/2.0d0 - strain2(2)*u(10)/2.0d0 + strain2(3)*u(9)/2.0d0 -v2(1)*d21qn(1)-v2(2)*d22qn(1)-v2(3)*d23qn(1))
	F(9) =L2*(strain2(1)*u(10)/2.0d0 + strain2(2)*u(11)/2.0d0 - strain2(3)*u(8)/2.0d0 -v2(1)*d21qn(2)-v2(2)*d22qn(2)-v2(3)*d23qn(2))
	F(10) =L2*(-strain2(1)*u(9)/2.0d0 + strain2(2)*u(8)/2.0d0 + strain2(3)*u(11)/2.0d0-v2(1)*d21qn(3)-v2(2)*d22qn(3)-v2(3)*d23qn(3))
	F(11) =L2*(-strain2(1)*u(8)/2.0d0 - strain2(2)*u(9)/2.0d0 - strain2(3)*u(10)/2.0d0-v2(1)*d21qn(4)-v2(2)*d22qn(4)-v2(3)*d23qn(4))
      F(12) = L2*0.0D0
      F(13) = L2*0.0D0
      F(14) = L2*0.0D0
      F(15)=  L2*( ( (C1+C2)*u(16)/(C1*C2) ) - (m2(3)/C1) + (uhat23-uhat13) )   ! Alpha
      
      ater1 = ( m2(1)*sin(u(15)) - m2(2)*cos(u(15)) )*A2*uhat21/(A1+A2) + (m2(1)*COS(u(15)) + m2(2)*SIN(u(15)))*A2*uhat22/(A1+A2) !Corrected -m2(2) to +ve
      ater2 = ((uhat21*uhat11 + uhat12*uhat22)*sin(u(15)) + (uhat11*uhat22 - uhat12*uhat21)*cos(u(15)))*A1*A2/(A1+A2)
      
      F(16) = L2*(ater1+ater2)                                                  ! Beta
  
  		
      ubar11=uhat11
      ubar12=uhat12
      ubar13=uhat13
      
      k11=A1
      k12=A1
      k13=C1
     
      m1(1) = (u(23)*u(24) + u(22)*u(25) - u(21)*u(26) - u(20)*u(27))/2.0d0
      m1(2) = (-u(22)*u(24) + u(23)*u(25) + u(20)*u(26) - u(21)*u(27))/2.0d0
      m1(3) = (u(21)*u(24) - u(20)*u(25) + u(23)*u(26) - u(22)*u(27))/2.0d0

!       The 4-vectors D_1[q] n, D_2[q] n, and D_3[q] n contain
!         the same 4 entries, but permuted and possibly negated.
!         Here are those entries

      entry11 =  2.0D0*(u(20)*u(28) + u(21)*u(29) + u(22)*u(30))
      entry12 =  2.0D0*(u(21)*u(28) - u(20)*u(29) + u(23)*u(30))
      entry13 =  2.0D0*(u(22)*u(28) - u(23)*u(29) - u(20)*u(30))
      entry14 =  2.0D0*(u(23)*u(28) + u(22)*u(29) - u(21)*u(30))

!       Components of D_1[q] n

      d11qn(1) =  entry11
      d11qn(2) =  -entry12
      d11qn(3) =  -entry13
      d11qn(4) =  entry14

!       Components of D_2[q] n

      d12qn(1) =  entry12
      d12qn(2) =  entry11
      d12qn(3) =  -entry14
      d12qn(4) =  -entry13

!       Components of D_3[q] n

      d13qn(1) =  entry13
      d13qn(2) =  entry14
      d13qn(3) =  entry11
      d13qn(4) =  entry12

!       Components of d1

      d11(1)= u(20)*u(20)-u(21)*u(21)-u(22)*u(22)+u(23)*u(23)
      d11(2)= 2.0d0*u(20)*u(21)+2.0d0*u(22)*u(23)
      d11(3)= 2.0d0*u(20)*u(22)-2.0d0*u(21)*u(23)

!       Components of d2

      d12(1)= 2.0d0*u(20)*u(21)-2.0d0*u(22)*u(23)
      d12(2)= -u(20)*u(20)+u(21)*u(21)-u(22)*u(22)+u(23)*u(23)
      d12(3)= 2.0d0*u(21)*u(22)+2.0d0*u(20)*u(23)

!       Components of d3
      d13(1)= 2.0d0*u(20)*u(22)+2.0d0*u(21)*u(23)
      d13(2)= 2.0d0*u(21)*u(22)-2.0d0*u(20)*u(23)
      d13(3)= -u(20)*u(20)-u(21)*u(21)+u(22)*u(22)+u(23)*u(23)
!       Components of v; note that v(3) has an extra term, due to
!         the fact that the unstressed state is assumed to have v=[0 0 1].
      v1(1)= epsilon/aa1*(d11(1)*u(28)+d11(2)*u(29)+d11(3)*u(30))
      v1(2)= epsilon/aa2*(d12(1)*u(28)+d12(2)*u(29)+d12(3)*u(30))
      v1(3)= epsilon/aa3*(d13(1)*u(28)+d13(2)*u(29)+d13(3)*u(30))+ 1.0d0
!       Calculate components of the strain
      strain1(1) = m1(1)/k11 + uhat11
      strain1(2) = m1(2)/k12 + uhat12
      strain1(3) = m1(3)/k13 + uhat13
      
     ! strain1(1) = strain2(1)
     ! strain1(2) = strain2(2)
     ! strain1(3) = strain2(3)
!       Now calculate the right hand sides
!       Additional terms      
     
      F(17) = L1*( v1(1)*d11(1)+v1(2)*d12(1)+v1(3)*d13(1))
      F(18) = L1*(v1(1)*d11(2)+v1(2)*d12(2)+v1(3)*d13(2))
      F(19) = L1*(v1(1)*d11(3)+v1(2)*d12(3)+v1(3)*d13(3))
      F(20) = L1*(strain1(1)*u(23)/2.0d0 - strain1(2)*u(22)/2.0d0 + strain1(3)*u(21)/2.0d0)
      F(21) = L1*(strain1(1)*u(22)/2.0d0 + strain1(2)*u(23)/2.0d0 - strain1(3)*u(20)/2.0d0)
      F(22) = L1*(-strain1(1)*u(21)/2.0d0 + strain1(2)*u(20)/2.0d0 + strain1(3)*u(23)/2.0d0)
      F(23) = L1*(-strain1(1)*u(20)/2.0d0 - strain1(2)*u(21)/2.0d0 - strain1(3)*u(22)/2.0d0)
F(24)=L1*(strain1(1)*u(27)/2.0d0- strain1(2)*u(26)/2.0d0 + strain1(3)*u(25)/2.0d0 -v1(1)*d11qn(1)-v1(2)*d12qn(1)-v1(3)*d13qn(1))
F(25)=L1*(strain1(1)*u(26)/2.0d0+ strain1(2)*u(27)/2.0d0-strain1(3)*u(24)/2.0d0 -v1(1)*d11qn(2)-v1(2)*d12qn(2)-v1(3)*d13qn(2))
F(26)=L1*(-strain1(1)*u(25)/2.0d0+ strain1(2)*u(24)/2.0d0+strain1(3)*u(27)/2.0d0 -v1(1)*d11qn(3)-v1(2)*d12qn(3)-v1(3)*d13qn(3))
F(27)=L1*(-strain1(1)*u(24)/2.0d0- strain1(2)*u(25)/2.0d0-strain1(3)*u(26)/2.0d0 -v1(1)*d11qn(4)-v1(2)*d12qn(4)-v1(3)*d13qn(4) )
      F(28) = L1*0.0D0
      F(29) = L1*0.0D0
      F(30) = L1*0.0D0
      
      
      
      
      
      m3(1) = ( u(23+14)*u(24+14) + u(22+14)*u(25+14) - u(21+14)*u(26+14) - u(20+14)*u(27+14))/2.0;
      m3(2) = (-u(22+14)*u(24+14) + u(23+14)*u(25+14) + u(20+14)*u(26+14) - u(21+14)*u(27+14))/2.0;
      m3(3) = ( u(21+14)*u(24+14) - u(20+14)*u(25+14) + u(23+14)*u(26+14) - u(22+14)*u(27+14))/2.0;

!%       The 4-vectors D_1[q] n, D_2[q] n, and D_3[q] n contain
!%         the same 4 entries, but permuted and possibly negated.
!%         Here are those entries

      entry31 =  2.0*(u(20+14)*u(28+14) + u(21+14)*u(29+14) + u(22+14)*u(30+14));
      entry32 =  2.0*(u(21+14)*u(28+14) - u(20+14)*u(29+14) + u(23+14)*u(30+14));
      entry33 =  2.0*(u(22+14)*u(28+14) - u(23+14)*u(29+14) - u(20+14)*u(30+14));
      entry34 =  2.0*(u(23+14)*u(28+14) + u(22+14)*u(29+14) - u(21+14)*u(30+14));!%Done

!%       Components of D_1[q] n

      d31qn(1) =  entry31;
      d31qn(2) = -entry32;
      d31qn(3) = -entry33;
      d31qn(4) =  entry34;

!%       Components of D_2[q] n

      d32qn(1) =  entry32;
      d32qn(2) =  entry31;
      d32qn(3) = -entry34;
      d32qn(4) = -entry33;

!%       Components of D_3[q] n

      d33qn(1) =  entry33;
      d33qn(2) =  entry34;
      d33qn(3) =  entry31;
      d33qn(4) =  entry32;

!%       Components of d1

      d31(1)= u(20+14)*u(20+14) - u(21+14)*u(21+14) - u(22+14)*u(22+14) + u(23+14)*u(23+14);
      d31(2)= 2.0*u(20+14)*u(21+14) + 2.0*u(22+14)*u(23+14);
      d31(3)= 2.0*u(20+14)*u(22+14) - 2.0*u(21+14)*u(23+14);

!%       Components of d2

      d32(1)= 2.0*u(20+14)*u(21+14) - 2.0*u(22+14)*u(23+14);
      d32(2)= -u(20+14)*u(20+14) + u(21+14)*u(21+14) - u(22+14)*u(22+14) + u(23+14)*u(23+14);
      d32(3)= 2.0*u(21+14)*u(22+14) + 2.0*u(20+14)*u(23+14);

!%       Components of d3
      d33(1)= 2.0*u(20+14)*u(22+14) + 2.0*u(21+14)*u(23+14);
      d33(2)= 2.0*u(21+14)*u(22+14) - 2.0*u(20+14)*u(23+14);
      d33(3)= -u(20+14)*u(20+14) - u(21+14)*u(21+14) + u(22+14)*u(22+14) + u(23+14)*u(23+14);
      
      
      
!%       Components of v; note that v(3) has an extra term, due to
!%         the fact that the unstressed state is assumed to have v=[0 0 1].
      v3(1)= epsilon/aa1*(d31(1)*u(28+14) + d31(2)*u(29+14) + d31(3)*u(30+14));
      v3(2)= epsilon/aa2*(d32(1)*u(28+14) + d32(2)*u(29+14) + d32(3)*u(30+14));
      v3(3)= epsilon/aa3*(d33(1)*u(28+14) + d33(2)*u(29+14) + d33(3)*u(30+14)) + 1.0;


     ab1=-C2*((U(47) + U(48))/C1 - m3(3)/C1  + U(47)/C2  - uhat13 ) 
     ab2=-C3*((U(47) + U(48))/C1 - m3(3)/C1  + U(48)/C3  - uhat13 )
    


    ub31=(A1*uhat11 + A2*(uhat21*COS(u(45))- uhat22*SIN(u(45)) ) + A3*(uhat31*COS(u(46))- uhat32*SIN(u(46))))/(A1+A2+A3)
	ub32=(A1*uhat12 + A2*(uhat21*SIN(u(45))+ uhat22*COS(u(45)) ) + A3*(uhat31*SIN(u(46))+ uhat32*COS(u(46))))/(A1+A2+A3)
	ub33= (ab1 + ab2 + C1*uhat13)/(C1+C2+C3)! Corrected addterm to uhat13 ------------------------


	kb31=A1+A2+A3;
	kb32=A1+A2+A3;
	kb33=C1+C2+C3; 
     
	strain3(1) = m3(1)/(A1+A2+A3) + ub31
	strain3(2) = m3(2)/(A1+A2+A3) + ub32
	strain3(3) = m3(3)/(C1+C2+C3) + ub33  

	F(31) = L3*(v3(1)*d31(1) + v3(2)*d32(1) + v3(3)*d33(1));
    F(32) = L3*(v3(1)*d31(2) + v3(2)*d32(2) + v3(3)*d33(2));
	F(33) = L3*(v3(1)*d31(3) + v3(2)*d32(3) + v3(3)*d33(3));
      
	F(34) = L3*( strain3(1)*u(23+14)/2.0 - strain3(2)*u(22+14)/2.0 + strain3(3)*u(21+14)/2.0);
    F(35) = L3*( strain3(1)*u(22+14)/2.0 + strain3(2)*u(23+14)/2.0 - strain3(3)*u(20+14)/2.0);
    F(36) = L3*(-strain3(1)*u(21+14)/2.0 + strain3(2)*u(20+14)/2.0 + strain3(3)*u(23+14)/2.0);
    F(37) = L3*(-strain3(1)*u(20+14)/2.0 - strain3(2)*u(21+14)/2.0 - strain3(3)*u(22+14)/2.0);
     
	F(38) = L3*( strain3(1)*u(27+14)/2.0 - strain3(2)*u(26+14)/2.0 + strain3(3)*u(25+14)/2.0 &
        - v3(1)*d31qn(1)-v3(2)*d32qn(1)-v3(3)*d33qn(1));
	F(39) = L3*( strain3(1)*u(26+14)/2.0 + strain3(2)*u(27+14)/2.0 - strain3(3)*u(24+14)/2.0 &
        - v3(1)*d31qn(2)-v3(2)*d32qn(2)-v3(3)*d33qn(2));
	F(40) = L3*(-strain3(1)*u(25+14)/2.0 + strain3(2)*u(24+14)/2.0 + strain3(3)*u(27+14)/2.0 &
        - v3(1)*d31qn(3)-v3(2)*d32qn(3)-v3(3)*d33qn(3));
	F(41) = L3*(-strain3(1)*u(24+14)/2.0 - strain3(2)*u(25+14)/2.0 - strain3(3)*u(26+14)/2.0 &
        - v3(1)*d31qn(4)-v3(2)*d32qn(4)-v3(3)*d33qn(4));
     
	F(42) = L3*0.0;
	F(43) = L3*0.0;
	F(44) = L3*0.0;
      

	F(45)= L3*((U(47) + U(48))/C1 - m3(3)/C1  + U(47)/C2 + uhat23- uhat13)  !!%Alfa2=U(45)
	F(46)= L3*((U(47) + U(48))/C1 - m3(3)/C1  + U(48)/C3 + uhat33- uhat13)  !!%Alfa3=U(46)


	F(47)=L3*(A2*uhat21*(A3*uhat31*SIN(U(45)-U(46)) + A1*uhat11*SIN(U(45)) ) )/(A1+A2+A3) &
              + L3*A2*uhat21*( m3(1)*SIN(U(45)) - m3(2)*COS(U(45)) )/(A1+A2+A3)
	F(48)=L3*(A3*uhat31*(A2*uhat21*SIN(U(46)-U(45)) + A1*uhat11*SIN(U(46)) ) )/(A1+A2+A3) &
              + L3*A3*uhat31*( m3(1)*SIN(U(46)) - m3(2)*COS(U(46)) )/(A1+A2+A3)
    

    	
        e201= -U(7)*U(11)/(4.0d0*k21)- U(6)*U(10)/(4.0d0*k22)- U(5)*U(9)/(4.0d0*C1) + 0.0d0                  ! 3 rd component only with k23 
	e202= -U(7)*U(10)/(4.0d0*k21)+ U(6)*U(11)/(4.0d0*k22)+ U(5)*U(8)/(4.0d0*C1) + (strain2(3)/2.0d0)
	e203=  U(7)*U(9)/(4.0d0*k21) + U(6)*U(8)/(4.0d0*k22) - U(5)*U(11)/(4.0d0*C1)- (strain2(2)/2.0d0)
	e204=  U(7)*U(8)/(4.0d0*k21) - U(6)*U(9)/(4.0d0*k22) + U(5)*U(10)/(4.0d0*C1) + (strain2(1)/2.0d0)
	!perfect
	e205=  U(7)*U(7)/(4.0d0*k21) + U(6)*U(6)/(4.0d0*k22) + U(5)*U(5)/(4.0d0*C1)
	e206=  U(6)*U(7)/(4.0d0*k21) - U(7)*U(6)/(4.0d0*k22) - U(4)*U(5)/(4.0d0*C1)
	e207= -U(5)*U(7)/(4.0d0*k21) - U(4)*U(6)/(4.0d0*k22) + U(7)*U(5)/(4.0d0*C1)
	e208= -U(4)*U(7)/(4.0d0*k21) + U(5)*U(6)/(4.0d0*k22) - U(6)*U(5)/(4.0d0*C1)
  
	a201= ( A2*U(7)*(-uhat21*SIN(u(15)) - uhat22*COS(u(15))) - A2*U(6)*( uhat21*COS(u(15))- uhat22*SIN( u(15))) )/(2.0d0*(A1+A2))
	b201= -U(5)/(2.0d0*C1)  ! -C2/k23 *   2.0d0 is missing find


    ! D q2
	e211= -U(6)*U(11)/(4.0d0*k21)+ U(7)*U(10)/(4.0d0*k22)+ U(4)*U(9)/(4.0d0*C1) - strain2(3)/2.0d0
	e212= -U(6)*U(10)/(4.0d0*k21)- U(7)*U(11)/(4.0d0*k22)- U(4)*U(8)/(4.0d0*C1) + 0.0d0
	e213=  U(6)*U(9)/(4.0d0*k21) - U(7)*U(8)/(4.0d0*k22) + U(4)*U(11)/(4.0d0*C1) + strain2(1)/2.0d0
	e214=  U(6)*U(8)/(4.0d0*k21) + U(7)*U(9)/(4.0d0*k22) - U(4)*U(10)/(4.0d0*C1) + strain2(2)/2.0d0
	
	e215=  U(7)*U(6)/(4.0d0*k21) - U(6)*U(7)/(4.0d0*k22) - U(5)*U(4)/(4.0d0*C1)
	e216=  U(6)*U(6)/(4.0d0*k21) + U(7)*U(7)/(4.0d0*k22) + U(4)*U(4)/(4.0d0*C1)
	e217=-U(5)*U(6)/(4.0d0*k21) + U(4)*U(7)/(4.0d0*k22) - U(7)*U(4)/(4.0d0*C1)
	e218=-U(4)*U(6)/(4.0d0*k21) - U(5)*U(7)/(4.0d0*k22) + U(6)*U(4)/(4.0d0*C1)

	a211= ( A2*U(6)*(-uhat21*SIN(u(15)) - uhat22*COS(u(15))) + A2*U(7)*(uhat21*COS(u(15))- uhat22*SIN(u(15))) )/(2.0d0*(A1+A2))
	b211= U(4)/(2.0d0*C1)

    ! D q3
	e221= +U(5)*U(11)/(4.0d0*k21)+ U(4)*U(10)/(4.0d0*k22) - U(7)*U(9)/(4.0d0*C1)  + strain2(2)/2.0d0
	e222= +U(5)*U(10)/(4.0d0*k21)- U(4)*U(11)/(4.0d0*k22) + U(7)*U(8)/(4.0d0*C1)  - strain2(1)/2.0d0
	e223= -U(5)*U(9)/(4.0d0*k21) - U(4)*U(8)/(4.0d0*k22)  - U(7)*U(11)/(4.0d0*C1) + 0.0d0
	e224= -U(5)*U(8)/(4.0d0*k21) + U(4)*U(9)/(4.0d0*k22)  + U(7)*U(10)/(4.0d0*C1) + strain2(3)/2.0d0
	
	e225= -U(7)*U(5)/(4.0d0*k21) - U(6)*U(4)/(4.0d0*k22) + U(5)*U(7)/(4.0d0*C1)
	e226= -U(6)*U(5)/(4.0d0*k21) + U(7)*U(4)/(4.0d0*k22) - U(4)*U(7)/(4.0d0*C1)
	e227= U(5)*U(5)/(4.0d0*k21) + U(4)*U(4)/(4.0d0*k22) + U(7)*U(7)/(4.0d0*C1)
	e228= U(4)*U(5)/(4.0d0*k21) - U(5)*U(4)/(4.0d0*k22) - U(6)*U(7)/(4.0d0*C1)
	
	a221= (-A2*U(5)*(-uhat21*SIN(u(15))-uhat22*COS(u(15)))+ A2*U(4)*(uhat21*COS(u(15))-uhat22*SIN( u(15))))/(2.0d0*(A1+A2))
	b221= -U(7)/(2.0d0*C1)

	! D q4
	e231= +U(4)*U(11)/(4.0d0*k21)- U(5)*U(10)/(4.0d0*k22)+ U(6)*U(9)/(4.0d0*C1)  - strain2(1)/2.0d0
	e232= +U(4)*U(10)/(4.0d0*k21)+ U(5)*U(11)/(4.0d0*k22)- U(6)*U(8)/(4.0d0*C1)  - strain2(2)/2.0d0	
	e233= -U(4)*U(9)/(4.0d0*k21) + U(5)*U(8)/(4.0d0*k22) + U(6)*U(11)/(4.0d0*C1) - strain2(3)/2.0d0
	e234= -U(4)*U(8)/(4.0d0*k21) - U(5)*U(9)/(4.0d0*k22) - U(6)*U(10)/(4.0d0*C1) + 0.0d0
	
	e235= -U(7)*U(4)/(4.0d0*k21) + U(6)*U(5)/(4.0d0*k22) - U(5)*U(6)/(4.0d0*C1)
	e236= -U(6)*U(4)/(4.0d0*k21) - U(7)*U(5)/(4.0d0*k22) + U(4)*U(6)/(4.0d0*C1)
	e237=  U(5)*U(4)/(4.0d0*k21) - U(4)*U(5)/(4.0d0*k22) - U(7)*U(6)/(4.0d0*C1)
	e238=  U(4)*U(4)/(4.0d0*k21) + U(5)*U(5)/(4.0d0*k22) + U(6)*U(6)/(4.0d0*C1)
	
	a231=(-A2*U(4)*(-uhat21*SIN(u(15))-uhat22*COS(u(15)))- A2*U(5)*(uhat21*COS(u(15))-uhat22*SIN( u(15))))/(2.0d0*(A1+A2))
	b231=U(6)/(2.0d0*C1)
    !perfect
    !d mu1
	e241= -U(11)*U(11)/(4.0d0*k21) - U(10)*U(10)/(4.0d0*k22)- U(9)*U(9)/(4.0d0*C1) +2.0d0*U(14)
	e242= -U(11)*U(10)/(4.0d0*k21) + U(10)*U(11)/(4.0d0*k22) + U(9)*U(8)/(4.0d0*C1)
	e243=  U(11)*U(9)/(4.0d0*k21)  + U(10)*U(8)/(4.0d0*k22) - U(9)*U(11)/(4.0d0*C1) -2.0d0*U(12)
	e244=  U(11)*U(8)/(4.0d0*k21) - U(10)*U(9)/(4.0d0*k22) + U(9)*U(10)/(4.0d0*C1)  +2.0d0*U(13)
	
	e245=  U(7)*U(11)/(4.0d0*k21) + U(6)*U(10)/(4.0d0*k22) + U(5)*U(9)/(4.0d0*C1) + 0.0d0
	e246=  U(6)*U(11)/(4.0d0*k21) - U(7)*U(10)/(4.0d0*k22) - U(4)*U(9)/(4.0d0*C1) + strain2(3)/2.0d0
	e247= -U(5)*U(11)/(4.0d0*k21) - U(4)*U(10)/(4.0d0*k22) + U(7)*U(9)/(4.0d0*C1) - strain2(2)/2.0d0
	e248= -U(4)*U(11)/(4.0d0*k21) + U(5)*U(10)/(4.0d0*k22) - U(6)*U(9)/(4.0d0*C1) + strain2(1)/2.0d0
	
	a241=(A2*U(11)*(-uhat21*SIN(u(15))- uhat22*COS(u(15))) - A2*U(10)*(uhat21*COS(u(15))- uhat22*SIN(u(15))) )/(2.0d0*(A1+A2))
	b241=-U(9)/(2.0d0*C1)

	!d mu2
	e251= -U(10)*U(11)/(4.0d0*k21) + U(11)*U(10)/(4.0d0*k22) + U(8)*U(9)/(4.0d0*C1)
	e252= -U(10)*U(10)/(4.0d0*k21) - U(11)*U(11)/(4.0d0*k22) - U(8)*U(8)/(4.0d0*C1)  + 2.0D0*U(14) 
	e253=  U(10)*U(9)/(4.0d0*k21)  - U(11)*U(8)/(4.0d0*k22)  + U(8)*U(11)/(4.0d0*C1) - 2.0D0*U(13)  	
	e254=  U(10)*U(8)/(4.0d0*k21)  + U(11)*U(9)/(4.0d0*k22)  - U(8)*U(10)/(4.0d0*C1) - 2.0D0*U(12) 

	e255=  U(7)*U(10)/(4.0d0*k21) - U(6)*U(11)/(4.0d0*k22) - U(5)*U(8)/(4.0d0*C1) - strain2(3)/2.0d0
	e256=  U(6)*U(10)/(4.0d0*k21) + U(7)*U(11)/(4.0d0*k22) + U(4)*U(8)/(4.0d0*C1) + 0.0d0
	e257= -U(5)*U(10)/(4.0d0*k21) + U(4)*U(11)/(4.0d0*k22) - U(7)*U(8)/(4.0d0*C1) + strain2(1)/2.0d0
	e258= -U(4)*U(10)/(4.0d0*k21) - U(5)*U(11)/(4.0d0*k22) + U(6)*U(8)/(4.0d0*C1) + strain2(2)/2.0d0
	
	a251=(A2*U(10)*(-uhat21*SIN(u(15)) - uhat22*COS(u(15))) + A2*U(11)*(uhat21*COS(u(15))- uhat22*SIN(u(15))))/(2.0d0*(A1+A2))
	b251= U(8)/(2.0d0*C1)

   !d mu3
	e261= +U(9)*U(11)/(4.0d0*k21) + U(8)*U(10)/(4.0d0*k22) - U(11)*U(9)/(4.0d0*C1) - 2.0D0*U(12) 
	e262= +U(9)*U(10)/(4.0d0*k21) - U(8)*U(11)/(4.0d0*k22) + U(11)*U(8)/(4.0d0*C1) - 2.0D0*U(13) 
	e263= -U(9)*U(9)/(4.0d0*k21)  - U(8)*U(8)/(4.0d0*k22)  - U(11)*U(11)/(4.0d0*C1)- 2.0D0*U(14)  
	e264= -U(9)*U(8)/(4.0d0*k21)  + U(8)*U(9)/(4.0d0*k22)  + U(11)*U(10)/(4.0d0*C1) 
	
	e265= -U(7)*U(9)/(4.0d0*k21) - U(6)*U(8)/(4.0d0*k22) + U(5)*U(11)/(4.0d0*C1) + strain2(2)/2.0d0
	e266= -U(6)*U(9)/(4.0d0*k21) + U(7)*U(8)/(4.0d0*k22) - U(4)*U(11)/(4.0d0*C1) - strain2(1)/2.0d0
	e267= U(5)*U(9)/(4.0d0*k21) + U(4)*U(8)/(4.0d0*k22) + U(7)*U(11)/(4.0d0*C1) + 0.0d0
	e268= U(4)*U(9)/(4.0d0*k21) - U(5)*U(8)/(4.0d0*k22) - U(6)*U(11)/(4.0d0*C1) + strain2(3)/2.0d0
	
	a261=(-A2*U(9)*(-uhat21*SIN(u(15)) - uhat22*COS(u(15))) + A2*U(8)*(uhat21*COS(u(15))- uhat22*SIN(u(15))))/(2.0d0*(A1+A2))
	b261=-U(11)/(2.0d0*C1)

   !d mu4
	e271=  U(8)*U(11)/(4.0d0*k21) - U(9)*U(10)/(4.0d0*k22) + U(10)*U(9)/(4.0d0*C1) + 2.0D0*U(13) 
	e272=  U(8)*U(10)/(4.0d0*k21) + U(9)*U(11)/(4.0d0*k22) - U(10)*U(8)/(4.0d0*C1) - 2.0D0*U(12) 
	e273= -U(8)*U(9)/(4.0d0*k21)  + U(9)*U(8)/(4.0d0*k22)  + U(10)*U(11)/(4.0d0*C1)
	e274= -U(8)*U(8)/(4.0d0*k21)  - U(9)*U(9)/(4.0d0*k22)  - U(10)*U(10)/(4.0d0*C1)- 2.0D0*U(14)  	
	
	e275= -U(7)*U(8)/(4.0d0*k21) + U(6)*U(9)/(4.0d0*k22) - U(5)*U(10)/(4.0d0*C1) - strain2(1)/2.0d0
	e276= -U(6)*U(8)/(4.0d0*k21) - U(7)*U(9)/(4.0d0*k22) + U(4)*U(10)/(4.0d0*C1) - strain2(2)/2.0d0
	e277=  U(5)*U(8)/(4.0d0*k21) - U(4)*U(9)/(4.0d0*k22) - U(7)*U(10)/(4.0d0*C1) - strain2(3)/2.0d0
	e278=  U(4)*U(8)/(4.0d0*k21) + U(5)*U(9)/(4.0d0*k22) + U(6)*U(10)/(4.0d0*C1) - 0.0d0

	a271=(-A2*U(8)*(-uhat21*SIN(u(15))- uhat22*COS(u(15))) - A2*U(9)*(uhat21*COS(u(15))- uhat22*SIN(u(15))))/(2.0d0*(A1+A2))
	b271= U(10)/(2.0d0*C1)
 
     
    ! q1=u(4), q(2)=u(5), q(3)= u(6), q(4)= u(7), Mu(1)=u(8), Mu(2)=u(9), Mu(3)=u(10), Mu(4)=u(11)
    afq1= u(9)/(2.0d0*C1)    !Mu(2)
    afq2=-u(8)/(2.0d0*C1)    !-Mu(1) 
    afq3= u(11)/(2.0d0*C1)   ! Mu(4)
    afq4=-u(10)/(2.0d0*C1)    !-Mu(3)
    afm1=-u(5)/(2.0d0*C1)   !-Q(2)
    afm2= u(4)/(2.0d0*C1)    ! Q(1)
    afm3=-u(7)/(2.0d0*C1)   !-Q(4)
    afm4= u(6)/(2.0d0*C1)   ! Q(3)
       
   
   !uhat21 not included
    bq1= ( -U(11)*SIN(U(15)) + U(10)*(-COS(U(15))) )*A2*uhat21/(2.0d0*(A1+A2))  !-Mu(4)    Mu(3)
    bq2= ( -U(10)*SIN(U(15)) - U(11)*(-COS(U(15))) )*A2*uhat21/(2.0d0*(A1+A2))   !-Mu(3)   -Mu(4)
    bq3= (  U(9)*SIN(U(15))  - U(8)*( -COS(U(15))) )*A2*uhat21/(2.0d0*(A1+A2))   ! MU(2)   -Mu(1)
    bq4= (  U(8)*SIN(U(15))  + U(9)*( -COS(U(15))) )*A2*uhat21/(2.0d0*(A1+A2)) ! Mu(1     Mu(2)
   
    bm1= (  U(7)*SIN(U(15))  - U(6)*(-COS(U(15))))*A2*uhat21/(2.0d0*(A1+A2))   ! q4       -q3
    bm2= (  U(6)*SIN(U(15))  + U(7)*(-COS(U(15))))*A2*uhat21/(2.0d0*(A1+A2))  ! q3        q4
    bm3= ( -U(5)*SIN(U(15))  + U(4)*(-COS(U(15))))*A2*uhat21/(2.0d0*(A1+A2))   !-q2        q1
    bm4= ( -U(4)*SIN(U(15))  - U(5)*(-COS(U(15))))*A2*uhat21/(2.0d0*(A1+A2))  !-q1       -q2
    ba1=  A1*A2*uhat11*uhat21*COS(U(15))/(A1+A2) + ( m2(1)*COS(U(15)) + m2(2)*SIN(U(15)))*A2*uhat21/(A1+A2) ! Pending
  
  
  	w201= -U(16+7)*U(16+11)/(4.0d0*k11)- U(16+6)*U(16+10)/(4.0d0*k12)- U(16+5)*U(16+9)/(4.0d0*k13) + 0.0d0                  ! 3 rd component only with k13 
	w202= -U(16+7)*U(16+10)/(4.0d0*k11)+ U(16+6)*U(16+11)/(4.0d0*k12)+ U(16+5)*U(16+8)/(4.0d0*k13) + (strain1(3)/2.0d0)
	w203=  U(16+7)*U(16+9)/(4.0d0*k11) + U(16+6)*U(16+8)/(4.0d0*k12) - U(16+5)*U(16+11)/(4.0d0*k13)- (strain1(2)/2.0d0)
	w204=  U(16+7)*U(16+8)/(4.0d0*k11) - U(16+6)*U(16+9)/(4.0d0*k12)+ U(16+5)*U(16+10)/(4.0d0*k13) + (strain1(1)/2.0d0)
	!perfect
	w205=  U(16+7)*U(16+7)/(4.0d0*k11) + U(16+6)*U(16+6)/(4.0d0*k12) + U(16+5)*U(16+5)/(4.0d0*k13)
	w206=  U(16+6)*U(16+7)/(4.0d0*k11) - U(16+7)*U(16+6)/(4.0d0*k12) - U(16+4)*U(16+5)/(4.0d0*k13)
	w207= -U(16+5)*U(16+7)/(4.0d0*k11) - U(16+4)*U(16+6)/(4.0d0*k12) + U(16+7)*U(16+5)/(4.0d0*k13)
	w208= -U(16+4)*U(16+7)/(4.0d0*k11) + U(16+5)*U(16+6)/(4.0d0*k12) - U(16+6)*U(16+5)/(4.0d0*k13)
    !Good
    !Changes


	w211= -U(16+6)*U(16+11)/(4.0d0*k11)+ U(16+7)*U(16+10)/(4.0d0*k12)+ U(16+4)*U(16+9)/(4.0d0*k13) - strain1(3)/2.0d0
	w212= -U(16+6)*U(16+10)/(4.0d0*k11)- U(16+7)*U(16+11)/(4.0d0*k12)- U(16+4)*U(16+8)/(4.0d0*k13) + 0.0d0
	w213=  U(16+6)*U(16+9)/(4.0d0*k11) - U(16+7)*U(16+8)/(4.0d0*k12) + U(16+4)*U(16+11)/(4.0d0*k13) + strain1(1)/2.0d0
	w214=  U(16+6)*U(16+8)/(4.0d0*k11) + U(16+7)*U(16+9)/(4.0d0*k12) - U(16+4)*U(16+10)/(4.0d0*k13) + strain1(2)/2.0d0
	
	w215=  U(16+7)*U(16+6)/(4.0d0*k11) - U(16+6)*U(16+7)/(4.0d0*k12) - U(16+5)*U(16+4)/(4.0d0*k13)
	w216=  U(16+6)*U(16+6)/(4.0d0*k11) + U(16+7)*U(16+7)/(4.0d0*k12) + U(16+4)*U(16+4)/(4.0d0*k13)
	w217= -U(16+5)*U(16+6)/(4.0d0*k11) + U(16+4)*U(16+7)/(4.0d0*k12) - U(16+7)*U(16+4)/(4.0d0*k13)
	w218= -U(16+4)*U(16+6)/(4.0d0*k11) - U(16+5)*U(16+7)/(4.0d0*k12) + U(16+6)*U(16+4)/(4.0d0*k13)


	w221= +U(16+5)*U(16+11)/(4.0d0*k11)+ U(16+4)*U(16+10)/(4.0d0*k12) - U(16+7)*U(16+9)/(4.0d0*k13)  + strain1(2)/2.0d0
	w222= +U(16+5)*U(16+10)/(4.0d0*k11)- U(16+4)*U(16+11)/(4.0d0*k12) + U(16+7)*U(16+8)/(4.0d0*k13)  - strain1(1)/2.0d0
	w223= -U(16+5)*U(16+9)/(4.0d0*k11) - U(16+4)*U(16+8)/(4.0d0*k12)  - U(16+7)*U(16+11)/(4.0d0*k13) + 0.0d0
	w224= -U(16+5)*U(16+8)/(4.0d0*k11) + U(16+4)*U(16+9)/(4.0d0*k12)  + U(16+7)*U(16+10)/(4.0d0*k13) + strain1(3)/2.0d0
	
	w225= -U(16+7)*U(16+5)/(4.0d0*k11) - U(16+6)*U(16+4)/(4.0d0*k12) + U(16+5)*U(16+7)/(4.0d0*k13)
	w226= -U(16+6)*U(16+5)/(4.0d0*k11) + U(16+7)*U(16+4)/(4.0d0*k12) - U(16+4)*U(16+7)/(4.0d0*k13)
	w227= U(16+5)*U(16+5)/(4.0d0*k11) + U(16+4)*U(16+4)/(4.0d0*k12) + U(16+7)*U(16+7)/(4.0d0*k13)
	w228= U(16+4)*U(16+5)/(4.0d0*k11) - U(16+5)*U(16+4)/(4.0d0*k12) - U(16+6)*U(16+7)/(4.0d0*k13)
	

	w231= +U(16+4)*U(16+11)/(4.0d0*k11)- U(16+5)*U(16+10)/(4.0d0*k12)+ U(16+6)*U(16+9)/(4.0d0*k13)  - strain1(1)/2.0d0
	w232= +U(16+4)*U(16+10)/(4.0d0*k11)+ U(16+5)*U(16+11)/(4.0d0*k12)- U(16+6)*U(16+8)/(4.0d0*k13)  - strain1(2)/2.0d0	
	w233= -U(16+4)*U(16+9)/(4.0d0*k11) + U(16+5)*U(16+8)/(4.0d0*k12) + U(16+6)*U(16+11)/(4.0d0*k13) - strain1(3)/2.0d0
	w234= -U(16+4)*U(16+8)/(4.0d0*k11) - U(16+5)*U(16+9)/(4.0d0*k12) - U(16+6)*U(16+10)/(4.0d0*k13) + 0.0d0
	
	w235= -U(16+7)*U(16+4)/(4.0d0*k11) + U(16+6)*U(16+5)/(4.0d0*k12) - U(16+5)*U(16+6)/(4.0d0*k13)
	w236= -U(16+6)*U(16+4)/(4.0d0*k11) - U(16+7)*U(16+5)/(4.0d0*k12) + U(16+4)*U(16+6)/(4.0d0*k13)
	w237=  U(16+5)*U(16+4)/(4.0d0*k11) - U(16+4)*U(16+5)/(4.0d0*k12) - U(16+7)*U(16+6)/(4.0d0*k13)
	w238=  U(16+4)*U(16+4)/(4.0d0*k11) + U(16+5)*U(16+5)/(4.0d0*k12) + U(16+6)*U(16+6)/(4.0d0*k13)
	!perfect
     

	w241= -U(16+11)*U(16+11)/(4.0d0*k11) - U(16+10)*U(16+10)/(4.0d0*k12)- U(16+9)*U(16+9)/(4.0d0*k13) +2.0d0*U(16+14)
	w242= -U(16+11)*U(16+10)/(4.0d0*k11) + U(16+10)*U(16+11)/(4.0d0*k12) + U(16+9)*U(16+8)/(4.0d0*k13)
	w243=  U(16+11)*U(16+9)/(4.0d0*k11)  + U(16+10)*U(16+8)/(4.0d0*k12) - U(16+9)*U(16+11)/(4.0d0*k13) -2.0d0*U(16+12)
	w244=  U(16+11)*U(16+8)/(4.0d0*k11) - U(16+10)*U(16+9)/(4.0d0*k12) + U(16+9)*U(16+10)/(4.0d0*k13)  +2.0d0*U(16+13)
	
	w245=  U(16+7)*U(16+11)/(4.0d0*k11) + U(16+6)*U(16+10)/(4.0d0*k12) + U(16+5)*U(16+9)/(4.0d0*k13) + 0.0d0
	w246=  U(16+6)*U(16+11)/(4.0d0*k11) - U(16+7)*U(16+10)/(4.0d0*k12) - U(16+4)*U(16+9)/(4.0d0*k13) + strain1(3)/2.0d0
	w247= -U(16+5)*U(16+11)/(4.0d0*k11) - U(16+4)*U(16+10)/(4.0d0*k12) + U(16+7)*U(16+9)/(4.0d0*k13) - strain1(2)/2.0d0
	w248= -U(16+4)*U(16+11)/(4.0d0*k11) + U(16+5)*U(16+10)/(4.0d0*k12) - U(16+6)*U(16+9)/(4.0d0*k13) + strain1(1)/2.0d0
	
	w251= -U(16+10)*U(16+11)/(4.0d0*k11) + U(16+11)*U(16+10)/(4.0d0*k12) + U(16+8)*U(16+9)/(4.0d0*k13)
	w252= -U(16+10)*U(16+10)/(4.0d0*k11) - U(16+11)*U(16+11)/(4.0d0*k12) - U(16+8)*U(16+8)/(4.0d0*k13)  + 2.0D0*U(16+14) 
	w253=  U(16+10)*U(16+9)/(4.0d0*k11)  - U(16+11)*U(16+8)/(4.0d0*k12)  + U(16+8)*U(16+11)/(4.0d0*k13) - 2.0D0*U(16+13)  	
	w254=  U(16+10)*U(16+8)/(4.0d0*k11)  + U(16+11)*U(16+9)/(4.0d0*k12)  - U(16+8)*U(16+10)/(4.0d0*k13) - 2.0D0*U(16+12) 

	w255=  U(16+7)*U(16+10)/(4.0d0*k11) - U(16+6)*U(16+11)/(4.0d0*k12) - U(16+5)*U(16+8)/(4.0d0*k13) - strain1(3)/2.0d0
	w256=  U(16+6)*U(16+10)/(4.0d0*k11) + U(16+7)*U(16+11)/(4.0d0*k12) + U(16+4)*U(16+8)/(4.0d0*k13) + 0.0d0
	w257= -U(16+5)*U(16+10)/(4.0d0*k11) + U(16+4)*U(16+11)/(4.0d0*k12) - U(16+7)*U(16+8)/(4.0d0*k13) + strain1(1)/2.0d0
	w258= -U(16+4)*U(16+10)/(4.0d0*k11) - U(16+5)*U(16+11)/(4.0d0*k12) + U(16+6)*U(16+8)/(4.0d0*k13) + strain1(2)/2.0d0
	
	w261= +U(16+9)*U(16+11)/(4.0d0*k11) + U(16+8)*U(16+10)/(4.0d0*k12) - U(16+11)*U(16+9)/(4.0d0*k13) - 2.0D0*U(16+12) 
	w262= +U(16+9)*U(16+10)/(4.0d0*k11) - U(16+8)*U(16+11)/(4.0d0*k12) + U(16+11)*U(16+8)/(4.0d0*k13) - 2.0D0*U(16+13) 
	w263= -U(16+9)*U(16+9)/(4.0d0*k11)  - U(16+8)*U(16+8)/(4.0d0*k12)  - U(16+11)*U(16+11)/(4.0d0*k13)- 2.0D0*U(16+14)  
	w264= -U(16+9)*U(16+8)/(4.0d0*k11)  + U(16+8)*U(16+9)/(4.0d0*k12)  + U(16+11)*U(16+10)/(4.0d0*k13) 
	
	w265= -U(16+7)*U(16+9)/(4.0d0*k11) - U(16+6)*U(16+8)/(4.0d0*k12) + U(16+5)*U(16+11)/(4.0d0*k13) + strain1(2)/2.0d0
	w266= -U(16+6)*U(16+9)/(4.0d0*k11) + U(16+7)*U(16+8)/(4.0d0*k12) - U(16+4)*U(16+11)/(4.0d0*k13) - strain1(1)/2.0d0
	w267=  U(16+5)*U(16+9)/(4.0d0*k11) + U(16+4)*U(16+8)/(4.0d0*k12) + U(16+7)*U(16+11)/(4.0d0*k13) + 0.0d0
	w268=  U(16+4)*U(16+9)/(4.0d0*k11) - U(16+5)*U(16+8)/(4.0d0*k12) - U(16+6)*U(16+11)/(4.0d0*k13) + strain1(3)/2.0d0
	
	w271=  U(16+8)*U(16+11)/(4.0d0*k11) - U(16+9)*U(16+10)/(4.0d0*k12) + U(16+10)*U(16+9)/(4.0d0*k13) + 2.0D0*U(16+13) 
	w272=  U(16+8)*U(16+10)/(4.0d0*k11) + U(16+9)*U(16+11)/(4.0d0*k12) - U(16+10)*U(16+8)/(4.0d0*k13) - 2.0D0*U(16+12) 
	w273= -U(16+8)*U(16+9)/(4.0d0*k11)  + U(16+9)*U(16+8)/(4.0d0*k12)  + U(16+10)*U(16+11)/(4.0d0*k13)
	w274= -U(16+8)*U(16+8)/(4.0d0*k11)  - U(16+9)*U(16+9)/(4.0d0*k12)  - U(16+10)*U(16+10)/(4.0d0*k13)- 2.0D0*U(16+14)  	
	
	w275= -U(16+7)*U(16+8)/(4.0d0*k11) + U(16+6)*U(16+9)/(4.0d0*k12) - U(16+5)*U(16+10)/(4.0d0*k13) - strain1(1)/2.0d0
	w276= -U(16+6)*U(16+8)/(4.0d0*k11) - U(16+7)*U(16+9)/(4.0d0*k12) + U(16+4)*U(16+10)/(4.0d0*k13) - strain1(2)/2.0d0
	w277=  U(16+5)*U(16+8)/(4.0d0*k11) - U(16+4)*U(16+9)/(4.0d0*k12) - U(16+7)*U(16+10)/(4.0d0*k13) - strain1(3)/2.0d0
	w278=  U(16+4)*U(16+8)/(4.0d0*k11) + U(16+5)*U(16+9)/(4.0d0*k12) + U(16+6)*U(16+10)/(4.0d0*k13) - 0.0d0

	!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	! t: for three-tube

	t201= -U(37)*U(41)/(4.0d0*kb31) - U(36)*U(40)/(4.0d0*kb32)- U(35)*U(39)/(4.0d0*C1)+ 0.0d0                  ! 3 rd component only with k2
	t202= -U(37)*U(40)/(4.0d0*kb31) + U(36)*U(41)/(4.0d0*kb32)+ U(35)*U(38)/(4.0d0*C1)+ (strain3(3)/2.0d0)
	t203=  U(37)*U(39)/(4.0d0*kb31) + U(36)*U(38)/(4.0d0*kb32)- U(35)*U(41)/(4.0d0*C1)- (strain3(2)/2.0d0)
	t204=  U(37)*U(38)/(4.0d0*kb31) - U(36)*U(39)/(4.0d0*kb32)+ U(35)*U(40)/(4.0d0*C1)+ (strain3(1)/2.0d0)
	!perfect
	t205=  U(37)*U(37)/(4.0d0*kb31) + U(36)*U(36)/(4.0d0*kb32) + U(35)*U(35)/(4.0d0*C1)
	t206=  U(36)*U(37)/(4.0d0*kb31) - U(37)*U(36)/(4.0d0*kb32) - U(34)*U(35)/(4.0d0*C1)
	t207= -U(35)*U(37)/(4.0d0*kb31) - U(34)*U(36)/(4.0d0*kb32) + U(37)*U(35)/(4.0d0*C1)
	t208= -U(34)*U(37)/(4.0d0*kb31) + U(35)*U(36)/(4.0d0*kb32) - U(36)*U(35)/(4.0d0*C1)

	

	at201= ( A2*U(37)*(-uhat21*SIN(u(45)) - uhat22*COS(u(45))) - A2*U(36)*( uhat21*COS(u(45))- uhat22*SIN( u(45))) )/(2.0d0*(A1+A2+A3))
	at202= ( A3*U(37)*(-uhat31*SIN(u(46)) - uhat32*COS(u(46))) - A3*U(36)*( uhat31*COS(u(46))- uhat32*SIN( u(46))) )/(2.0d0*(A1+A2+A3))
	
	!bt201= U(35)*(-C2*(1/C1 + 1/C2) - C3*(1/C1))/(C1+C2+C3) 
	bt201= -U(35)/(2.0d0*C1)
	!bt202= U(35)*(-C2*(1/C1) - C3*(1/C1 + 1/C3))/(C1+C2+C3)
	bt202= -U(35)/(2.0d0*C1)
	

	
	
	   ! D q2
	t211= -U(36)*U(41)/(4.0d0*kb31)+ U(37)*U(40)/(4.0d0*kb32)+ U(34)*U(39)/(4.0d0*C1) - strain3(3)/2.0d0
	t212= -U(36)*U(40)/(4.0d0*kb31)- U(37)*U(41)/(4.0d0*kb32)- U(34)*U(38)/(4.0d0*C1) + 0.0d0
	t213=  U(36)*U(39)/(4.0d0*kb31) - U(37)*U(38)/(4.0d0*kb32) + U(34)*U(41)/(4.0d0*C1) + strain3(1)/2.0d0
	t214=  U(36)*U(38)/(4.0d0*kb31) + U(37)*U(39)/(4.0d0*kb32) - U(34)*U(40)/(4.0d0*C1) + strain3(2)/2.0d0
	
	t215=  U(37)*U(36)/(4.0d0*kb31) - U(36)*U(37)/(4.0d0*kb32) - U(35)*U(34)/(4.0d0*C1)
	t216=  U(36)*U(36)/(4.0d0*kb31) + U(37)*U(37)/(4.0d0*kb32) + U(34)*U(34)/(4.0d0*C1)
	t217= -U(35)*U(36)/(4.0d0*kb31) + U(34)*U(37)/(4.0d0*kb32) - U(37)*U(34)/(4.0d0*C1)
	t218= -U(34)*U(36)/(4.0d0*kb31) - U(35)*U(37)/(4.0d0*kb32) + U(36)*U(34)/(4.0d0*C1)

	at211= ( A2*U(36)*(-uhat21*SIN(u(45)) - uhat22*COS(u(45))) + A2*U(37)*(uhat21*COS(u(45))- uhat22*SIN(u(45))) )/(2.0d0*(A1+A2+A3))
	at212= ( A3*U(36)*(-uhat31*SIN(u(46)) - uhat32*COS(u(46))) + A3*U(37)*(uhat31*COS(u(46))- uhat32*SIN(u(46))) )/(2.0d0*(A1+A2+A3))
	
	!bt211= -U(34)*(-C2*(1/C1 + 1/C2) - C3*(1/C1))/(C1+C2+C3) 
	!bt212= -U(34)*(-C2*(1/C1) - C3*(1/C1 + 1/C3))/(C1+C2+C3)
	
	bt211= U(34)/(2.0d0*C1)
	bt212= U(34)/(2.0d0*C1)


    ! D q3
	t221= +U(35)*U(41)/(4.0d0*kb31) + U(34)*U(40)/(4.0d0*kb32) - U(37)*U(39)/(4.0d0*C1)  + strain3(2)/2.0d0
	t222= +U(35)*U(40)/(4.0d0*kb31) - U(34)*U(41)/(4.0d0*kb32) + U(37)*U(38)/(4.0d0*C1)  - strain3(1)/2.0d0
	t223= -U(35)*U(39)/(4.0d0*kb31) - U(34)*U(38)/(4.0d0*kb32) - U(37)*U(41)/(4.0d0*C1) + 0.0d0
	t224= -U(35)*U(38)/(4.0d0*kb31) + U(34)*U(39)/(4.0d0*kb32) + U(37)*U(40)/(4.0d0*C1) + strain3(3)/2.0d0
	
	t225= -U(37)*U(35)/(4.0d0*kb31) - U(36)*U(34)/(4.0d0*kb32) + U(35)*U(37)/(4.0d0*C1)
	t226= -U(36)*U(35)/(4.0d0*kb31) + U(37)*U(34)/(4.0d0*kb32) - U(34)*U(37)/(4.0d0*C1)
	t227=  U(35)*U(35)/(4.0d0*kb31) + U(34)*U(34)/(4.0d0*kb32) + U(37)*U(37)/(4.0d0*C1)
	t228=  U(34)*U(35)/(4.0d0*kb31) - U(35)*U(34)/(4.0d0*kb32) - U(36)*U(37)/(4.0d0*C1)
	

	at221= (-A2*U(35)*(-uhat21*SIN(u(45)) - uhat22*COS(u(45))) + A2*U(34)*(uhat21*COS(u(45))- uhat22*SIN(u(45))) )/(2.0d0*(A1+A2+A3))
	at222= (-A3*U(35)*(-uhat31*SIN(u(46)) - uhat32*COS(u(46))) + A3*U(34)*(uhat31*COS(u(46))- uhat32*SIN(u(46))) )/(2.0d0*(A1+A2+A3))
	
	!bt221= U(37)*(-C2*(1/C1 + 1/C2) -C3*(1/C1))/(2.0d0*(C1+C2+C3)) 
	!bt222= U(37)*(-C2*(1/C1) - C3*(1/C1 + 1/C3))/(2.0d0*(C1+C2+C3)) 
	bt221=-U(37)/(2.0d0*C1)
	bt222=-U(37)/(2.0d0*C1)

	! D q4
	t231= +U(34)*U(41)/(4.0d0*kb31)- U(35)*U(40)/(4.0d0*kb32)+ U(36)*U(39)/(4.0d0*C1)  - strain3(1)/2.0d0
	t232= +U(34)*U(40)/(4.0d0*kb31)+ U(35)*U(41)/(4.0d0*kb32)- U(36)*U(38)/(4.0d0*C1)  - strain3(2)/2.0d0	
	t233= -U(34)*U(39)/(4.0d0*kb31) + U(35)*U(38)/(4.0d0*kb32) + U(36)*U(41)/(4.0d0*C1) - strain3(3)/2.0d0
	t234= -U(34)*U(38)/(4.0d0*kb31) - U(35)*U(39)/(4.0d0*kb32) - U(36)*U(40)/(4.0d0*C1) + 0.0d0
	
	t235= -U(37)*U(34)/(4.0d0*kb31) + U(36)*U(35)/(4.0d0*kb32) - U(35)*U(36)/(4.0d0*C1)
	t236= -U(36)*U(34)/(4.0d0*kb31) - U(37)*U(35)/(4.0d0*kb32) + U(34)*U(36)/(4.0d0*C1)
	t237=  U(35)*U(34)/(4.0d0*kb31) - U(34)*U(35)/(4.0d0*kb32) - U(37)*U(36)/(4.0d0*C1)
	t238=  U(34)*U(34)/(4.0d0*kb31) + U(35)*U(35)/(4.0d0*kb32) + U(36)*U(36)/(4.0d0*C1)
	

	at231= (-A2*U(34)*(-uhat21*SIN(u(45)) - uhat22*COS(u(45))) - A2*U(35)*(uhat21*COS(u(45))- uhat22*SIN(u(45))) )/(2.0d0*(A1+A2+A3))
	at232= (-A3*U(34)*(-uhat31*SIN(u(46)) - uhat32*COS(u(46))) - A3*U(35)*(uhat31*COS(u(46))- uhat32*SIN(u(46))) )/(2.0d0*(A1+A2+A3))
	

	bt231= U(36)/(2.0d0*C1)
	bt232= U(36)/(2.0d0*C1)
	
	!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	!! Checked OK
	
	t241= -U(41)*U(41)/(4.0d0*kb31) - U(40)*U(40)/(4.0d0*kb32)- U(39)*U(39)/(4.0d0*C1) + 2.0d0*U(44)
	t242= -U(41)*U(40)/(4.0d0*kb31) + U(40)*U(41)/(4.0d0*kb32) + U(39)*U(38)/(4.0d0*C1)
	t243=  U(41)*U(39)/(4.0d0*kb31)  + U(40)*U(38)/(4.0d0*kb32) - U(39)*U(41)/(4.0d0*C1) -2.0d0*U(42)
	t244=  U(41)*U(38)/(4.0d0*kb31) - U(40)*U(39)/(4.0d0*kb32) + U(39)*U(40)/(4.0d0*C1)  +2.0d0*U(43)
	
	t245=  U(37)*U(41)/(4.0d0*kb31) + U(36)*U(40)/(4.0d0*kb32) + U(35)*U(39)/(4.0d0*C1) + 0.0d0
	t246=  U(36)*U(41)/(4.0d0*kb31) - U(37)*U(40)/(4.0d0*kb32) - U(34)*U(39)/(4.0d0*C1) + strain3(3)/2.0d0
	t247= -U(35)*U(41)/(4.0d0*kb31) - U(34)*U(40)/(4.0d0*kb32) + U(37)*U(39)/(4.0d0*C1) - strain3(2)/2.0d0
	t248= -U(34)*U(41)/(4.0d0*kb31) + U(35)*U(40)/(4.0d0*kb32) - U(36)*U(39)/(4.0d0*C1) + strain3(1)/2.0d0
	
	at241=(A2*U(41)*(-uhat21*SIN(u(45))- uhat22*COS(u(45))) - A2*U(40)*(uhat21*COS(u(45))- uhat22*SIN(u(45))) )/(2.0d0*(A1+A2+A3))
	at242=(A3*U(41)*(-uhat31*SIN(u(46))- uhat32*COS(u(46))) - A3*U(40)*(uhat31*COS(u(46))- uhat32*SIN(u(46))) )/(2.0d0*(A1+A2+A3))
	
	!bt241= U(39)*(-C2*(1/C1 + 1/C2) -C3*(1/C1))/(2.0d0*(C1+C2+C3)) 
	!bt242= U(39)*(-C2*(1/C1) - C3*(1/C1 + 1/C3))/(2.0d0*(C1+C2+C3)) 
	
	bt241= -U(39)/(2.0d0*C1)
	bt242= -U(39)/(2.0d0*C1)

	!d mu2
	t251= -U(40)*U(41)/(4.0d0*kb31) + U(41)*U(40)/(4.0d0*kb32) + U(38)*U(39)/(4.0d0*C1)
	t252= -U(40)*U(40)/(4.0d0*kb31) - U(41)*U(41)/(4.0d0*kb32) - U(38)*U(38)/(4.0d0*C1)  + 2.0D0*U(44) 
	t253=  U(40)*U(39)/(4.0d0*kb31)  - U(41)*U(38)/(4.0d0*kb32)  + U(38)*U(41)/(4.0d0*C1) - 2.0D0*U(43)  	
	t254=  U(40)*U(38)/(4.0d0*kb31)  + U(41)*U(39)/(4.0d0*kb32)  - U(38)*U(40)/(4.0d0*C1) - 2.0D0*U(42) 

	t255=  U(37)*U(40)/(4.0d0*kb31) - U(36)*U(41)/(4.0d0*kb32) - U(35)*U(38)/(4.0d0*C1) - strain3(3)/2.0d0
	t256=  U(36)*U(40)/(4.0d0*kb31) + U(37)*U(41)/(4.0d0*kb32) + U(34)*U(38)/(4.0d0*C1) + 0.0d0
	t257= -U(35)*U(40)/(4.0d0*kb31) + U(34)*U(41)/(4.0d0*kb32) - U(37)*U(38)/(4.0d0*C1) + strain3(1)/2.0d0
	t258= -U(34)*U(40)/(4.0d0*kb31) - U(35)*U(41)/(4.0d0*kb32) + U(36)*U(38)/(4.0d0*C1) + strain3(2)/2.0d0

	
	at251=(A2*U(40)*(-uhat21*SIN(u(45))- uhat22*COS(u(45))) + A2*U(41)*(uhat21*COS(u(45))- uhat22*SIN(u(45))) )/(2.0d0*(A1+A2+A3))
	at252=(A3*U(40)*(-uhat31*SIN(u(46))- uhat32*COS(u(46))) + A3*U(41)*(uhat31*COS(u(46))- uhat32*SIN(u(46))) )/(2.0d0*(A1+A2+A3))
		
	!bt251= -U(38)*(-C2*(1/C1 + 1/C2) -C3*(1/C1))/(2.0d0*(C1+C2+C3))  
	!bt252= -U(38)*(-C2*(1/C1) - C3*(1/C1 + 1/C3))/(2.0d0*(C1+C2+C3)) 
	bt251=  U(38)/(2.0d0*C1)
	bt252=  U(38)/(2.0d0*C1)
	

   !d mu3
	t261= +U(39)*U(41)/(4.0d0*kb31) + U(38)*U(40)/(4.0d0*kb32) - U(41)*U(39)/(4.0d0*C1) - 2.0D0*U(42) 
	t262= +U(39)*U(40)/(4.0d0*kb31) - U(38)*U(41)/(4.0d0*kb32) + U(41)*U(38)/(4.0d0*C1) - 2.0D0*U(43) 
	t263= -U(39)*U(39)/(4.0d0*kb31)  - U(38)*U(38)/(4.0d0*kb32)  - U(41)*U(41)/(4.0d0*C1)- 2.0D0*U(44)  
	t264= -U(39)*U(38)/(4.0d0*kb31)  + U(38)*U(39)/(4.0d0*kb32)  + U(41)*U(40)/(4.0d0*C1) 
	
	t265= -U(37)*U(39)/(4.0d0*kb31) - U(36)*U(38)/(4.0d0*kb32) + U(35)*U(41)/(4.0d0*C1) + strain3(2)/2.0d0
	t266= -U(36)*U(39)/(4.0d0*kb31) + U(37)*U(38)/(4.0d0*kb32) - U(34)*U(41)/(4.0d0*C1) - strain3(1)/2.0d0
	t267= U(35)*U(39)/(4.0d0*kb31) + U(34)*U(38)/(4.0d0*kb32) + U(37)*U(41)/(4.0d0*C1) + 0.0d0
	t268= U(34)*U(39)/(4.0d0*kb31) - U(35)*U(38)/(4.0d0*kb32) - U(36)*U(41)/(4.0d0*C1) + strain3(3)/2.0d0

	
	at261=(-A2*U(39)*(-uhat21*SIN(u(45))- uhat22*COS(u(45))) + A2*U(38)*(uhat21*COS(u(45))- uhat22*SIN(u(45))) )/(2.0d0*(A1+A2+A3))
	at262=(-A3*U(39)*(-uhat31*SIN(u(46))- uhat32*COS(u(46))) + A3*U(38)*(uhat31*COS(u(46))- uhat32*SIN(u(46))) )/(2.0d0*(A1+A2+A3))
		
	!bt261= U(41)*(-C2*(1/C1 + 1/C2) -C3*(1/C1))/(2.0d0*(C1+C2+C3)) 
	!bt262= U(41)*(-C2*(1/C1) - C3*(1/C1 + 1/C3))/(2.0d0*(C1+C2+C3)) 
	
	bt261= -U(41)/(2.0d0*C1)
	bt262= -U(41)/(2.0d0*C1)

   !d mu4
	t271=  U(38)*U(41)/(4.0d0*kb31) - U(39)*U(40)/(4.0d0*kb32) + U(40)*U(39)/(4.0d0*C1) + 2.0D0*U(43) 
	t272=  U(38)*U(40)/(4.0d0*kb31) + U(39)*U(41)/(4.0d0*kb32) - U(40)*U(38)/(4.0d0*C1) - 2.0D0*U(42) 
	t273= -U(38)*U(39)/(4.0d0*kb31)  + U(39)*U(38)/(4.0d0*kb32)  + U(40)*U(41)/(4.0d0*C1)
	t274= -U(38)*U(38)/(4.0d0*kb31)  - U(39)*U(39)/(4.0d0*kb32)  - U(40)*U(40)/(4.0d0*C1)- 2.0D0*U(44)  	
	
	t275= -U(37)*U(38)/(4.0d0*kb31) + U(36)*U(39)/(4.0d0*kb32) - U(35)*U(40)/(4.0d0*C1) - strain3(1)/2.0d0
	t276= -U(36)*U(38)/(4.0d0*kb31) - U(37)*U(39)/(4.0d0*kb32) + U(34)*U(40)/(4.0d0*C1) - strain3(2)/2.0d0
	t277=  U(35)*U(38)/(4.0d0*kb31) - U(34)*U(39)/(4.0d0*kb32) - U(37)*U(40)/(4.0d0*C1) - strain3(3)/2.0d0
	t278=  U(34)*U(38)/(4.0d0*kb31) + U(35)*U(39)/(4.0d0*kb32) + U(36)*U(40)/(4.0d0*C1) - 0.0d0
	
	at271=(-A2*U(38)*(-uhat21*SIN(u(45))- uhat22*COS(u(45))) - A2*U(39)*(uhat21*COS(u(45))- uhat22*SIN(u(45))) )/(2.0d0*(A1+A2+A3))
	at272=(-A3*U(38)*(-uhat31*SIN(u(46))- uhat32*COS(u(46))) - A3*U(39)*(uhat31*COS(u(46))- uhat32*SIN(u(46))) )/(2.0d0*(A1+A2+A3))

	!bt271= -U(40)*(-C2*(1/C1 + 1/C2) -C3*(1/C1))/(2.0d0*(C1+C2+C3))  
	!bt272= -U(40)*(-C2*(1/C1)- C3*(1/C1 + 1/C3))/(2.0d0*(C1+C2+C3)) 
	bt271= U(40)/(2.0d0*C1)
	bt272= U(40)/(2.0d0*C1)
	
	
	af2q1= U(39)/(2.0d0*C1)   ! Mu(2)
    af2q2=-U(38)/(2.0d0*C1)   !-Mu(1) 
    af2q3= U(41)/(2.0d0*C1)   ! Mu(4)
    af2q4=-U(40)/(2.0d0*C1)   !-Mu(3)
    af2m1=-U(35)/(2.0d0*C1)  !-Q(2)
    af2m2=+U(34)/(2.0d0*C1)  ! Q(1)
    af2m3=-U(37)/(2.0d0*C1)  !-Q(4)
    af2m4= U(36)/(2.0d0*C1)  ! Q(3)

    af2b2=(1/C1 + 1/C2)
    af2b3=1/C1
	
	af3q1= U(39)/(2.0d0*C1)     !Mu(2)
    af3q2=-U(38)/(2.0d0*C1)   !-Mu(1) 
    af3q3= U(41)/(2.0d0*C1)     ! Mu(4)
    af3q4=-U(40)/(2.0d0*C1)     !-Mu(3)
    
    af3m1=-U(35)/(2.0d0*C1)   !-Q(2)
    af3m2=+U(34)/(2.0d0*C1)   ! Q(1)
    af3m3=-U(37)/(2.0d0*C1)   !-Q(4)
    af3m4= U(36)/(2.0d0*C1)   ! Q(3)

    af3b2= 1/C1
    af3b3= 1/C1 + 1/C3
	
	b2q1= ( -U(41)*SIN(U(45)) + U(40)*(-COS(U(45))) )*A2*uhat21/(2.0d0*(A1+A2+A3))  !-Mu(4)    Mu(3)
    b2q2= ( -U(40)*SIN(U(45)) - U(41)*(-COS(U(45))) )*A2*uhat21/(2.0d0*(A1+A2+A3))   !-Mu(3)   -Mu(4)
    b2q3= (  U(39)*SIN(U(45)) - U(38)*(-COS(U(45))) )*A2*uhat21/(2.0d0*(A1+A2+A3))   ! MU(2)   -Mu(1)
    b2q4= (  U(38)*SIN(U(45)) + U(39)*(-COS(U(45))) )*A2*uhat21/(2.0d0*(A1+A2+A3)) ! Mu(1     Mu(2)
   
    b2m1= (  U(37)*SIN(U(45))  - U(36)*(-COS(U(45))))*A2*uhat21/(2.0d0*(A1+A2+A3))   ! q4       -q3
    b2m2= (  U(36)*SIN(U(45))  + U(37)*(-COS(U(45))))*A2*uhat21/(2.0d0*(A1+A2+A3))  ! q3        q4
    b2m3= ( -U(35)*SIN(U(45))  + U(34)*(-COS(U(45))))*A2*uhat21/(2.0d0*(A1+A2+A3))   !-q2        q1
    b2m4= ( -U(34)*SIN(U(45))  - U(35)*(-COS(U(45))))*A2*uhat21/(2.0d0*(A1+A2+A3))  !-q1       -q2
	
	b2a2=A2*uhat21*(A1*uhat11*COS(U(45)) + A3*uhat31*COS(U(45) - U(46)))/(A1+A2+A3)  &
	     + A2*uhat21*(m3(1)*COS(U(45)) + m3(2)*SIN(U(45)))/(A1+A2+A3)
	b2a3=A2*uhat21*(-A3*uhat31*COS(U(45) - U(46)))/(A1+A2+A3)
	


	
	b3q1= ( -U(41)*SIN(U(46)) + U(40)*(-COS(U(46))))*A3*uhat31/(2.0d0*(A1+A2+A3))  	!-Mu(4)    Mu(3)
    b3q2= ( -U(40)*SIN(U(46)) - U(41)*(-COS(U(46))))*A3*uhat31/(2.0d0*(A1+A2+A3))   !-Mu(3)   -Mu(4)
    b3q3= (  U(39)*SIN(U(46)) - U(38)*(-COS(U(46))))*A3*uhat31/(2.0d0*(A1+A2+A3))   ! MU(2)   -Mu(1)
    b3q4= (  U(38)*SIN(U(46)) + U(39)*(-COS(U(46))))*A3*uhat31/(2.0d0*(A1+A2+A3)) 	! Mu(1     Mu(2)
   
    b3m1= (  U(37)*SIN(U(46))  - U(36)*(-COS(U(46))))*A3*uhat31/(2.0d0*(A1+A2+A3))   ! q4       -q3
    b3m2= (  U(36)*SIN(U(46))  + U(37)*(-COS(U(46))))*A3*uhat31/(2.0d0*(A1+A2+A3))   ! q3        q4
    b3m3= ( -U(35)*SIN(U(46))  + U(34)*(-COS(U(46))))*A3*uhat31/(2.0d0*(A1+A2+A3))   !-q2        q1
    b3m4= ( -U(34)*SIN(U(46))  - U(35)*(-COS(U(46))))*A3*uhat31/(2.0d0*(A1+A2+A3))   !-q1       -q2
    
    
    b3a2=A3*uhat31*(-A2*uhat21*COS(U(46) - U(45)))/(A1+A2+A3)
    b3a3=A3*uhat31*(A1*uhat11*COS(U(46)) + A2*uhat21*COS(U(46) - U(45)))/(A1+A2+A3) &
    	 + A3*uhat31*(m3(1)*COS(U(46)) + m3(2)*SIN(U(46)))/(A1+A2+A3)
	

	DO I=1,5
  	I1=48 + 30*(I-1)


    F(I1+1)=L2*(e201*u(I1+1) + e202*u(I1+2) + e203*u(I1+3) + e204*u(I1+4) + e205*u(I1+5) + e206*u(I1+6) + e207*u(I1+7) &
            + e208*u(I1+8)+ a201*u(I1+9) + b201*u(I1+10))
    F(I1+2)=L2*(e211*u(I1+1) + e212*u(I1+2) + e213*u(I1+3) + e214*u(I1+4) + e215*u(I1+5) + e216*u(I1+6) + e217*u(I1+7) &
            + e218*u(I1+8) + a211*u(I1+9) + b211*u(I1+10))
    F(I1+3)=L2*(e221*u(I1+1) + e222*u(I1+2) + e223*u(I1+3) + e224*u(I1+4) + e225*u(I1+5) + e226*u(I1+6) + e227*u(I1+7) &
            + e228*u(I1+8)+ a221*u(I1+9) + b221*u(I1+10))
    F(I1+4)=L2*(e231*u(I1+1) + e232*u(I1+2) + e233*u(I1+3) + e234*u(I1+4) + e235*u(I1+5) + e236*u(I1+6) + e237*u(I1+7) &
            + e238*u(I1+8)+ a231*u(I1+9) + b231*u(I1+10))

    F(I1+5)= L2*(e241*u(I1+1) + e242*u(I1+2) + e243*u(I1+3) + e244*u(I1+4) + e245*u(I1+5) + e246*u(I1+6) + e247*u(I1+7) &
	        + e248*u(I1+8)  + a241*u(I1+9) + b241*u(I1+10)) 	     
    F(I1+6)= L2*(e251*u(I1+1) + e252*u(I1+2) + e253*u(I1+3) + e254*u(I1+4) + e255*u(I1+5) + e256*u(I1+6) + e257*u(I1+7) &
            + e258*u(I1+8)   + a251*u(I1+9) + b251*u(I1+10))
    F(I1+7)= L2*(e261*u(I1+1) + e262*u(I1+2) + e263*u(I1+3) + e264*u(I1+4) + e265*u(I1+5) + e266*u(I1+6) + e267*u(I1+7) &
            + e268*u(I1+8)  + a261*u(I1+9) + b261*u(I1+10)) 
    F(I1+8)= L2*(e271*u(I1+1) + e272*u(I1+2) + e273*u(I1+3) + e274*u(I1+4) + e275*u(I1+5) + e276*u(I1+6) + e277*u(I1+7) &
            + e278*u(I1+8)   + a271*u(I1+9) + b271*u(I1+10))
  
    
    
    F(I1+9)=L2*( afq1*U(I1+1) + afq2*u(I1+2) + afq3*U(I1+3) + afq4*U(I1+4) + afm1*U(I1+5) + afm2*u(I1+6) + afm3*U(I1+7) &
             +afm4*U(I1+8) + (C1+C2)*U(I1+10)/(C1*C2) )
    F(I1+10)=L2*(  bq1*U(I1+1) +  bq2*U(I1+2) +  bq3*U(I1+3) +  bq4*U(I1+4) +  bm1*U(I1+5) +   bm2*U(I1+6)  +bm3*U(I1+7) &
	        +bm4*U(I1+8) + ba1*U(I1+9) ) 
	


    F(I1+11)=L1*(w201*U(I1+11) + w202*U(I1+12) + w203*U(I1+13) + w204*U(I1+14) + w205*U(I1+15) + w206*U(I1+16) + w207*U(I1+17) &
            + w208*U(I1+18))
    F(I1+12)=L1*(w211*U(I1+11) + w212*U(I1+12) + w213*U(I1+13) + w214*U(I1+14) + w215*U(I1+15) + w216*U(I1+16) + w217*U(I1+17) &
            + w218*U(I1+18)) 
    F(I1+13)=L1*(w221*U(I1+11) + w222*U(I1+12) + w223*U(I1+13) + w224*U(I1+14) + w225*U(I1+15) + w226*U(I1+16) + w227*U(I1+17) &
            + w228*U(I1+18)) 
    F(I1+14)=L1*(w231*U(I1+11) + w232*U(I1+12) + w233*U(I1+13) + w234*U(I1+14) + w235*U(I1+15) + w236*U(I1+16) + w237*U(I1+17) &
            + w238*U(I1+18)) 

	F(I1+15)= L1*(w241*U(I1+11) + w242*U(I1+12) + w243*U(I1+13) + w244*U(I1+14) + w245*U(I1+15) + w246*U(I1+16) + w247*U(I1+17) &
	        + w248*U(I1+18)) !+ 2.0d0*( -U(16+6)*U(I1+28) + u(16+7)*U(I1+29) + U(16+4)*U(I1+30) ) )	!+ a241*u(I1+15) + b241*u(I1+16) 	     
    F(I1+16)= L1*(w251*U(I1+11) + w252*U(I1+12) + w253*U(I1+13) + w254*U(I1+14) + w255*U(I1+15) + w256*U(I1+16) + w257*U(I1+17) &
            + w258*U(I1+18)) ! + 2.0d0*( -u(16+7)*U(I1+28) - U(16+6)*U(I1+29) + U(16+5)*U(I1+30))) !+ a251*u(I1+15) + b251*u(I1+16)
    F(I1+17)= L1*(w261*U(I1+11) + w262*U(I1+12) + w263*U(I1+13) + w264*U(I1+14) + w265*U(I1+15) + w266*U(I1+16) + w267*U(I1+17) &
            + w268*U(I1+18)) !+ 2.0d0*( -U(16+4)*U(I1+28) - U(16+5)*U(I1+29) - U(16+6)*U(I1+30)))  !+ a261*u(I1+15) + b261*u(I1+16) 
    F(I1+18)= L1*(w271*U(I1+11) + w272*U(I1+12) + w273*U(I1+13) + w274*U(I1+14) + w275*U(I1+15) + w276*U(I1+16) + w277*U(I1+17) &
            + w278*U(I1+18)) ! + 2.0d0*( -U(16+5)*U(I1+28) + U(16+4)*U(I1+29) - u(16+7)*U(I1+30))) ! + a271*u(I1+15) + b271*u(I1+16)
  
    
     F(I1+19)=L3*(t201*u(I1+19) + t202*u(I1+20) + t203*u(I1+21) + t204*u(I1+22) + t205*u(I1+23) + t206*u(I1+24) + t207*u(I1+25) &
            + t208*u(I1+26) + at201*u(I1+27) + at202*u(I1+28) + bt201*u(I1+29) + bt202*u(I1+30))
    F(I1+20)=L3*(t211*u(I1+19) + t212*u(I1+20) + t213*u(I1+21) + t214*u(I1+22) + t215*u(I1+23) + t216*u(I1+24) + t217*u(I1+25) &
            + t218*u(I1+26) + at211*u(I1+27) + at212*u(I1+28) + bt211*u(I1+29) + bt212*u(I1+30))
    F(I1+21)=L3*(t221*u(I1+19) + t222*u(I1+20) + t223*u(I1+21) + t224*u(I1+22) + t225*u(I1+23) + t226*u(I1+24) + t227*u(I1+25) &
            + t228*u(I1+26) + at221*u(I1+27) + at222*u(I1+28) + bt221*u(I1+29) + bt222*u(I1+30))
    F(I1+22)=L3*(t231*u(I1+19) + t232*u(I1+20) + t233*u(I1+21) + t234*u(I1+22) + t235*u(I1+23) + t236*u(I1+24) + t237*u(I1+25) &
            + t238*u(I1+26) + at231*u(I1+27) + at232*u(I1+28) + bt231*u(I1+29) + bt232*u(I1+30))

  F(I1+23)=L3*(t241*u(I1+19) + t242*u(I1+20) + t243*u(I1+21) + t244*u(I1+22) + t245*u(I1+23) + t246*u(I1+24) + t247*u(I1+25) &
            + t248*u(I1+26) + at241*u(I1+27) + at242*u(I1+28) + bt241*u(I1+29) + bt242*u(I1+30) )

    F(I1+24)=L3*(t251*u(I1+19) + t252*u(I1+20) + t253*u(I1+21) + t254*u(I1+22) + t255*u(I1+23) + t256*u(I1+24) + t257*u(I1+25) &
            + t258*u(I1+26) + at251*u(I1+27) + at252*u(I1+28) + bt251*u(I1+29) + bt252*u(I1+30) )
           
    F(I1+25)=L3*(t261*u(I1+19) + t262*u(I1+20) + t263*u(I1+21) + t264*u(I1+22) + t265*u(I1+23) + t266*u(I1+24) + t267*u(I1+25) &
            + t268*u(I1+26) + at261*u(I1+27) + at262*u(I1+28) + bt261*u(I1+29) + bt262*u(I1+30) )
            
    F(I1+26)=L3*(t271*u(I1+19) + t272*u(I1+20) + t273*u(I1+21) + t274*u(I1+22) + t275*u(I1+23) + t276*u(I1+24) + t277*u(I1+25) &
            + t278*u(I1+26) + at271*u(I1+27) + at272*u(I1+28) + bt271*u(I1+29) + bt272*u(I1+30) )
           

    F(I1+27)=L3*(af2q1*u(I1+19) +af2q2*u(I1+20) +af2q3*u(I1+21) +af2q4*u(I1+22) +af2m1*u(I1+23) +af2m2*u(I1+24) + af2m3*u(I1+25)&
             + af2m4*u(I1+26) + af2b2*u(I1+29) + af2b3*u(I1+30) )
    F(I1+28)=L3*(af3q1*u(I1+19) +af3q2*u(I1+20) +af3q3*u(I1+21) +af3q4*u(I1+22) +af3m1*u(I1+23) +af3m2*u(I1+24) + af3m3*u(I1+25)&
             + af3m4*u(I1+26) + af3b2*u(I1+29) + af3b3*u(I1+30) )


    F(I1+29)=L3*(b2q1*u(I1+19) +b2q2*u(I1+20) + b2q3*u(I1+21) + b2q4*u(I1+22) + b2m1*u(I1+23) +b2m2*u(I1+24) + b2m3*u(I1+25) &
             + b2m4*u(I1+26) + b2a2*u(I1+27) + b2a3*u(I1+28) )
    F(I1+30)=L3*(b3q1*u(I1+19) +b3q2*u(I1+20) + b3q3*u(I1+22) + b3q4*u(I1+22) + b3m1*u(I1+23) +b3m2*u(I1+24) + b3m3*u(I1+25) &
             + b3m4*u(I1+26) + b3a2*u(I1+27) + b3a3*u(I1+28) )
    
    ENDDO

         
      RETURN
      END

      SUBROUTINE STPNT(NDIM,U,PAR,T)
!     ---------- -----
!
      IMPLICIT NONE
      INTEGER, INTENT(IN) :: NDIM
      DOUBLE PRECISION, INTENT(INOUT) :: U(NDIM),PAR(*)
      DOUBLE PRECISION, INTENT(IN) :: T
      DOUBLE PRECISION k1,k2,k3,ubar1,ubar2,pi
      pi = 4.d0*ATAN(1.d0)
      PAR(1)=0.0001d0 		!uhat11
      PAR(2)=0.0d0 		!uhat13
      PAR(3)=0.0d0
      PAR(4)= 0.0001d0 
      PAR(5)= 0.0d0
	  PAR(6)= 0.0d0
	  PAR(7)= 0.0d0
	  PAR(8)= 0.0d0
	  PAR(9)= 0.0d0
	  PAR(10)=0.0001d0
	  PAR(11)=0.0d0 
      PAR(12)=0.0d0  
      PAR(13)=0.0d0  
      
      
      U= 0.0d0
      U(3)=PAR(10) + PAR(1)*T   
      U(7)=1.0d0

      U(19)=PAR(1) + PAR(10) + PAR(4)*T   
      U(23)=1.0d0
      
      U(33)=PAR(10)*T
      U(37)=1.0d0
      

   
!
      RETURN
      END
!                                                                      
!
! &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
!
!
      SUBROUTINE BCND(NDIM,PAR,ICP,NBC,U0,U1,FB,IJAC,DBC)
!     ---------- ----

      IMPLICIT NONE
      INTEGER, INTENT(IN) :: NDIM, ICP(*), NBC, IJAC
      DOUBLE PRECISION, INTENT(IN) :: PAR(*), U0(NDIM), U1(NDIM)
      DOUBLE PRECISION, INTENT(OUT) :: FB(NBC)
      DOUBLE PRECISION, INTENT(INOUT) :: DBC(NBC,*)
      DOUBLE PRECISION pi,nx,ny,nz,e1,d111,d112,d113,d121,d122,d123,d131,d132,d133,e2,e3,Ndir1,Ndir2,Ndir3,DNdir1,DNdir2,DNdir3,bas
      DOUBLE PRECISION ang1,ang2,ang3,intb2,intb3,mb31,mb32,mb33,mb21,mb22,mb23
      INTEGER I1,I

      pi = 4.d0*ATAN(1.d0)
      
      nz=PAR(7)*0.0d0
      nx=PAR(7)*SIN(PAR(8))
      ny=PAR(7)*COS(PAR(8))
      ang1=PAR(9)
      ang2=PAR(2)
      ang3=PAR(12)
      bas=PAR(13)
      
      e1=0.0d0 	
      e2=0.1d0
      e3=0.0d0
   
     ! q1,q2,q3,q4, u20,u21,u22,u23   
   	 
      d111= u1(20)*u1(20) - u1(21)*u1(21) - u1(22)*u1(22) + u1(23)*u1(23)
      d112= 2.0d0*u1(20)*u1(21) + 2.0d0*u1(22)*u1(23)
      d113= 2.0d0*u1(20)*u1(22) - 2.0d0*u1(21)*u1(23)
   
      d121= 2.0d0*u1(20)*u1(21) - 2.0d0*u1(22)*u1(23)
      d122= -u1(20)*u1(20) + u1(21)*u1(21)- u1(22)*u1(22) + u1(23)*u1(23)
      d123= 2.0d0*u1(21)*u1(22) + 2.0d0*u1(20)*u1(23)

      d131= 2.0d0*u1(20)*u1(22) + 2.0d0*u1(21)*u1(23)
      d132= 2.0d0*u1(21)*u1(22) - 2.0d0*u1(20)*u1(23)
      d133= -u1(20)*u1(20) - u1(21)*u1(21) + u1(22)*u1(22) + u1(23)*u1(23)
   
     ! r X N
      Ndir1=nx*d111 + ny*d112 + nz*d113  
      Ndir2=nx*d121 + ny*d122 + nz*d123  
      Ndir3=nx*d131 + ny*d132 + nz*d133  
      
      
     !Boundary Conditions
           
      FB(1)=U0(1) - U1(31);
      FB(2)=U0(2) - U1(32);
      FB(3)=U0(3) - U1(33);
	  	  
      FB(4)=U0(4) - U1(34);
      FB(5)=U0(5) - U1(35); 
      FB(6)=U0(6) - U1(36); 
      FB(7)=U0(7) - U1(37); ! Dirichlet BCs coupled
      
      FB(8)= U1(8) -U0(24);
      FB(9)= U1(9) -U0(25); 
      FB(10)=U1(10)-U0(26); 
      FB(11)=U1(11)-U0(27);
	       
     
      FB(12)=U1(12) - U0(28); 
      FB(13)=U1(13) - U0(29);
      FB(14)=U1(14) - U0(30); !Neumann Coupled between the 2-tube and 1-tube
      
        
      FB(15)=U0(15) - U1(45) !Dirichlet Condition on the end of tube twist
      FB(16)=U1(16);         !Neumann Condition on the end of tube twist
      
      
      FB(17)=U0(17) - U1(1);
      FB(18)=U0(18) - U1(2);
      FB(19)=U0(19) - U1(3);
      
      FB(20)=U0(20) - U1(4);
      FB(21)=U0(21) - U1(5);
      FB(22)=U0(22) - U1(6);
      FB(23)=U0(23) - U1(7); !Dirichlet BCs coupled at the boundary between 2 tube section and 1 tube
      
      FB(24)= ( U1(16+7)*U1(16+8) + U1(16+6)*U1(16+9) - U1(16+5)*U1(16+10) - U1(16+4)*U1(16+11))/2.0d0 +(e2*Ndir3 - e3*Ndir2)
      FB(25)= (-U1(16+6)*U1(16+8) + U1(16+7)*U1(16+9) + U1(16+4)*U1(16+10) - U1(16+5)*U1(16+11))/2.0d0 +(e3*Ndir1 - e1*Ndir3)!
      FB(26)= ( U1(16+5)*U1(16+8) - U1(16+4)*U1(16+9) + U1(16+7)*U1(16+10) - U1(16+6)*U1(16+11))/2.0d0 +(e1*Ndir2 - e2*Ndir1)
	    
	  FB(27)=  U0(24)*U0(20) + U0(25)*U0(21)+ U0(26)*U0(22)+ U0(27)*U0(23) + 2.0d0*(U0(17)*U0(28) + U0(18)*U0(29) + U0(19)*U0(30)) !Neumann BCs on the tip
      
      FB(28)=U1(28) + nx;
      FB(29)=U1(29) + ny;
      FB(30)=U1(30) + nz;!Neumann BCs on the tip
                       
      FB(31)=U0(31); 
      FB(32)=U0(32);
      FB(33)=U0(33);
      
      FB(34)=U0(34);
      FB(35)=U0(35);
      FB(36)=U0(36) - SIN(ang1/2);
      FB(37)=U0(37) - COS(ang1/2);  ! Dirichlet BCs coupled 
   
      mb31 = ( u1(23+14)*u1(24+14) + u1(22+14)*u1(25+14) - u1(21+14)*u1(26+14) - u1(20+14)*u1(27+14));
      mb32 = (-u1(22+14)*u1(24+14) + u1(23+14)*u1(25+14) + u1(20+14)*u1(26+14) - u1(21+14)*u1(27+14));
      mb32 = ( u1(21+14)*u1(24+14) - u1(20+14)*u1(25+14) + u1(23+14)*u1(26+14) - u1(22+14)*u1(27+14));
intb3= u1(38)*u1(34) + u1(39)*u1(35)+ u1(40)*u1(36)+ u1(41)*u1(37) + 2.0*(u1(31)*u1(42) + u1(32)*u1(43) + u1(33)*u1(44))
intb2= U0(8)*U0(4) + U0(9)*U0(5)+ U0(10)*U0(6)+ U0(11)*U0(7) + 2.0*(U0(1)*U0(12) + U0(2)*U0(13) + U0(3)*U0(14))
      
      mb21 = ( U0(7)*U0(8) + U0(6)*U0(9) - U0(5)*U0(10) - U0(4)*U0(11)) 
      mb22 = (-U0(6)*U0(8) + U0(7)*U0(9) + U0(4)*U0(10) - U0(5)*U0(11)) 
      mb23 = ( U0(5)*U0(8) - U0(4)*U0(9) + U0(7)*U0(10) - U0(6)*U0(11)) 
       
      FB(38)=U1(42) - U0(12);
      FB(39)=U1(43) - U0(13);
      FB(40)=U1(44) - U0(14);
      
      FB(41)=U1(38) - U0(8); !mb31 - mb21
      FB(42)=U1(39) - U0(9); !mb32 - mb22
      FB(43)=U1(40) - U0(10);!mb33 - mb23
      FB(44)=U1(41) - U0(11);!Neumann Conditions Coupled
	
      FB(45)=U0(45) - ang2; 
      FB(46)=U0(46) - ang3;! Dirichlet BCs coupled 
      FB(47)=U1(47) - U0(16);
      FB(48)=U1(48);
  
      DO I=1,5
        I1=48 + 30*(I-1)
      	

	  	FB(I1+1)=U1(I1+1)  - U0(I1+11)
	  	FB(I1+2)=U1(I1+2)  - U0(I1+12)
	  	FB(I1+3)=U1(I1+3)  - U0(I1+13)
	  	FB(I1+4)=U1(I1+4)  - U0(I1+14)
	  	
	  	
	  	FB(I1+5)=U1(I1+5)  - U0(I1+15)
	  	FB(I1+6)=U1(I1+6)  - U0(I1+16)
	  	FB(I1+7)=U1(I1+7)  - U0(I1+17)
	  	FB(I1+8)=U1(I1+8)  - U0(I1+18)

      	

      	
      	FB(I1+9) = U1(I1+9)     ! D alfa
        FB(I1+10)= U1(I1+10)	 ! D beta =0
        
        FB(I1+11)= U1(I1+11) !q ! dq1=0
        FB(I1+12)= U1(I1+12)    ! dq2=0
        FB(I1+13)= U1(I1+13)    ! dq3=0
        FB(I1+14)= U1(I1+14)    ! dq4=0
        
        
    	DNdir1 = 2.0d0*nx*(U1(20)*U1(I1+11) - U1(21)*U1(I1+12) - U1(22)*U1(I1+13) + U1(23)*U1(I1+14)) &
                +2.0d0*ny*(U1(20)*U1(I1+12) + U1(I1+11)*U1(21) + U1(22)*U1(I1+14) + U1(I1+13)*U1(23)) &
                +2.0d0*nz*(U1(20)*U1(I1+13) + U1(I1+11)*U1(22) - U1(21)*U1(I1+14) - U1(I1+12)*U1(23))
        
        DNdir2 = 2.0d0*nx*(U1(20)*U1(I1+12) + U1(I1+11)*U1(21) - U1(22)*U1(I1+14) - U1(I1+13)*U1(23)) &
                +2.0d0*ny*(-U1(20)*U1(I1+11) + U1(21)*U1(I1+12) - U1(22)*U1(I1+13) + U1(23)*U1(I1+14)) &
                +2.0d0*nz*(U1(21)*U1(I1+13) + U1(I1+12)*U1(22) + U1(20)*U1(I1+14) + U1(I1+11)*U1(23))
          
               
        DNdir3 = 2.0d0*nx*(U1(20)*U1(I1+13) + U1(I1+11)*U1(22) + U1(21)*U1(I1+14) + U1(I1+12)*U1(23)) &
                +2.0d0*ny*(U1(21)*U1(I1+13) + U1(I1+12)*U1(22) - U1(20)*U1(I1+14) - U1(I1+11)*U1(23)) &
                +2.0d0*nz*(-U1(20)*U1(I1+11) - U1(21)*U1(I1+12) + U1(22)*U1(I1+13) + U1(23)*U1(I1+14)) 
        
        

	FB(I1+15)= (U1(16+7)*U1(I1+15) + U1(22)*U1(I1+16)- U1(5+16)*U1(I1+17) - U1(4+16)*U1(I1+18) &
	          + U1(I1+14)*U1(8+16) + U1(I1+13)*U1(9+16) - U1(I1+12)*U1(10+16) - U1(I1+11)*U1(11+16))/2.0d0 &
	        +(e2*DNdir3 - e3*DNdir2) 
	    
	FB(I1+16)=(-U1(6+16)*U1(I1+15) + U1(7+16)*U1(I1+16) + U1(4+16)*U1(I1+17) - U1(5+16)*U1(I1+18)&
	          - U1(I1+13)*U1(8+16) + U1(I1+14)*U1(9+16) + U1(I1+11)*U1(10+16)- U1(I1+12)*U1(11+16))/2.0d0&
	        +(e3*DNdir1 - e1*DNdir3)
      	
    FB(I1+17)= (U1(5+16)*U1(I1+15)- U1(4+16)*U1(I1+16) + U1(7+16)*U1(I1+17) - U1(6+16)*U1(I1+18)         &
      	      + U1(I1+12)*U1(8+16) - U1(I1+11)*U1(9+16) + U1(I1+14)*U1(10+16) - U1(I1+13)*U1(11+16))/2.0d0 &
      	      +(e1*DNdir2 - e2*DNdir1)
	    

        
        
      	FB(I1+18)=U1(20)*U1(I1+15) + U1(21)*U1(I1+16) + U1(22)*U1(I1+17)+ U1(23)*U1(I1+18)                   &
      	          +U1(I1+11)*U1(24) + U1(I1+12)*U1(25) + U1(I1+13)*U1(26) + U1(I1+14)*U1(27)                 
        


	  	FB(I1+19)=U1(I1+19) - U0(I1+1)
	  	FB(I1+20)=U1(I1+20) - U0(I1+2)
	  	FB(I1+21)=U1(I1+21) - U0(I1+3)
	  	FB(I1+22)=U1(I1+22) - U0(I1+4)

	  	FB(I1+23)=U1(I1+23) - U0(I1+5)
	  	FB(I1+24)=U1(I1+24) - U0(I1+6)
	  	FB(I1+25)=U1(I1+25) - U0(I1+7)
	  	FB(I1+26)=U1(I1+26) - U0(I1+8)        
        



      	
      	FB(I1+27)=U1(I1+27) - U0(I1+9)
        FB(I1+28)=U1(I1+28) 
      	FB(I1+29)=U1(I1+29) - U0(I1+10)
      	FB(I1+30)=U1(I1+30)
         
        
        ENDDO
      
 
      I1=48
      FB(I1+11)=U1(I1+11) - bas*U1(23)
      FB(I1+12)=U1(I1+12) - bas*U1(22)
      FB(I1+13)=U1(I1+13) + bas*U1(21)
      FB(I1+14)=U1(I1+14) + bas*U1(20)
      
      I1=48+30
      FB(I1+11)=U1(I1+11) + bas*U1(22)
      FB(I1+12)=U1(I1+12) - bas*U1(23)
      FB(I1+13)=U1(I1+13) - bas*U1(20)
      FB(I1+14)=U1(I1+14) + bas*U1(21)
      
      I1=48+60
      FB(I1+11)=U1(I1+11) - bas*U1(21)
      FB(I1+12)=U1(I1+12) + bas*U1(20)
      FB(I1+13)=U1(I1+13) - bas*U1(23)
      FB(I1+14)=U1(I1+14) + bas*U1(22)
      
      I1=48+90
      FB(I1+9)=U1(I1+9) - bas
      

      I1=48+120
      FB(I1+28)=U1(I1+28) - bas
  
   
      RETURN
      END
!                                                                      

      SUBROUTINE ICND
      END SUBROUTINE ICND

      SUBROUTINE FOPT 
      END SUBROUTINE FOPT

      SUBROUTINE PVLS
      END SUBROUTINE PVLS
